---
import BaseTailwind from '../../layouts/BaseTailwind.astro';

// Astro frontmatter for server-side configuration
export const prerender = true;

const baseUrl = import.meta.env.BASE_URL;
const promptBase = baseUrl.endsWith('/') ? `${baseUrl}prompt/` : `${baseUrl}/prompt/`;
---

<BaseTailwind
  title="Teleprompter — by MgLab"
  description="Laboratorio avanzado de ingeniería de prompts"
  lang="es"
>
  <link slot="head" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link slot="head" rel="stylesheet" href={`${promptBase}style.css`} />

  <div class="flex h-screen overflow-hidden bg-[var(--bs-body-bg)] text-[var(--bs-body-color)] font-sans" data-bs-theme="light">
  <!-- Sidebar -->
  <aside class="flex flex-col w-72 bg-[var(--bs-body-bg)] border-r border-[var(--bs-border-color)] shadow-lg">
    <!-- Sidebar Header -->
    <div class="relative overflow-hidden bg-gradient-to-br from-blue-600 to-blue-700 text-white px-6 py-5 flex-shrink-0">
      <div class="flex items-center gap-3 mb-1">
        <i class="fas fa-scroll text-2xl"></i>
        <h4 class="m-0 text-xl font-bold">Teleprompter</h4>
    </div>
      <p class="text-xs text-blue-100 font-medium">by MgLab</p>
      </div>
    
    <!-- Search -->
    <div class="px-4 py-3 border-b border-[var(--bs-border-color)] bg-[var(--bs-body-bg)]">
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--bs-secondary-color)] text-sm pointer-events-none"></i>
        <input 
          type="text" 
          id="sidebarSearch" 
          class="w-full pl-9 pr-3 py-2.5 rounded-lg text-sm bg-[var(--bs-secondary-bg)] border border-[var(--bs-border-color)] text-[var(--bs-body-color)] placeholder:text-[var(--bs-secondary-color)] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
          placeholder="Buscar técnica...">
    </div>
    </div>
    
    <!-- Sidebar Content -->
    <div class="flex-1 overflow-y-auto py-2" id="sidebarContent">
      <!-- Items will be populated by JS -->
    </div>
  </aside>

  <!-- Main content -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="flex items-center justify-between px-8 py-5 bg-[var(--bs-body-bg)] border-b border-[var(--bs-border-color)] shadow-sm">
      <h1 id="selectedTitle" class="m-0 text-2xl font-bold text-[var(--bs-heading-color)] flex items-center gap-3">
        <i class="fas fa-edit text-blue-600"></i>
        <span>Teleprompter</span>
      </h1>
      <div class="flex items-center gap-4">
        <button 
          id="themeToggle" 
          class="p-2.5 rounded-lg border border-[var(--bs-border-color)] bg-[var(--bs-secondary-bg)] text-[var(--bs-body-color)] hover:bg-[var(--bs-tertiary-bg)] transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500" 
          title="Cambiar tema">
          <i class="fas fa-moon text-base"></i>
        </button>
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 border border-amber-200">
          <i class="fas fa-university"></i>
          <span>Fines Educativos</span>
        </span>
        <button 
          id="helpIcon"
          class="p-2.5 rounded-lg text-blue-600 hover:bg-blue-50 hover:text-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
          title="Objetivo y Disclaimer">
          <i class="fas fa-question-circle text-lg"></i>
        </button>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8 space-y-6">
      <!-- Input section -->
      <section class="bg-[var(--bs-secondary-bg)] rounded-xl p-6 shadow-sm border border-[var(--bs-border-color)]">
        <label class="flex items-center gap-2 text-base font-semibold text-[var(--bs-body-color)] mb-4">
          <i class="fas fa-edit text-blue-600"></i>
          <span>Prompt</span>
        </label>
        <div class="flex gap-4 items-end">
          <textarea 
            id="prompt" 
            class="flex-1 min-h-[100px] px-4 py-3 rounded-lg border border-[var(--bs-border-color)] bg-[var(--bs-body-bg)] text-[var(--bs-body-color)] placeholder:text-[var(--bs-secondary-color)] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none" 
            rows="3" 
            placeholder="Escribe un prompt aquí..."
            spellcheck="false"></textarea>
          <button 
            id="genBtn" 
            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg whitespace-nowrap flex items-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-sm hover:shadow-md">
            <i class="fas fa-play"></i>
            <span>Generar</span>
          </button>
        </div>
        <div id="status" class="flex items-center justify-center gap-2 mt-4 text-sm text-[var(--bs-secondary-color)]">
          <i class="fas fa-check-circle text-green-500"></i>
          <span>Listo</span>
      </div>
      </section>

      <!-- Configuration section -->
      <section class="bg-[var(--bs-secondary-bg)] rounded-xl p-6 shadow-sm border border-[var(--bs-border-color)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <label class="flex items-center gap-2 text-sm font-semibold text-[var(--bs-body-color)] mb-3">
              <i class="fas fa-key text-red-500"></i>
              <span>API Key (Requerida)</span>
            </label>
            <input 
              id="openRouterKey" 
              type="password"
              class="w-full px-4 py-2.5 rounded-lg border border-[var(--bs-border-color)] bg-[var(--bs-body-bg)] text-[var(--bs-body-color)] placeholder:text-[var(--bs-secondary-color)] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all mb-2" 
              placeholder="Tu API Key de OpenRouter">
            <p class="text-xs text-[var(--bs-secondary-color)]">
              Consigue una en: 
              <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 hover:text-blue-700 underline">OpenRouter <i class="fas fa-external-link-alt text-[0.65rem]"></i></a> 
              o 
              <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:text-blue-700 underline">Google AI Studio <i class="fas fa-external-link-alt text-[0.65rem]"></i></a>
            </p>
          </div>
          <div>
            <label class="flex items-center gap-2 text-sm font-semibold text-[var(--bs-body-color)] mb-3">
              <i class="fas fa-cogs text-blue-600"></i>
              <span>Instrucciones Generales</span>
            </label>
            <input 
              id="generalInstructions" 
              class="w-full px-4 py-2.5 rounded-lg border border-[var(--bs-border-color)] bg-[var(--bs-body-bg)] text-[var(--bs-body-color)] placeholder:text-[var(--bs-secondary-color)] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
              placeholder="Instrucciones generales"
              value="Las respuestas deben ser en español.">
          </div>
        </div>
      </section>

      <!-- Dual Output section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
        <!-- Left Panel: Instructions -->
        <div class="flex flex-col bg-[var(--bs-secondary-bg)] rounded-xl p-6 shadow-sm border border-[var(--bs-border-color)] min-h-0">
          <div class="flex items-center gap-2 text-base font-semibold text-[var(--bs-body-color)] mb-4 flex-shrink-0">
            <i class="fas fa-info-circle text-blue-600"></i>
            <span>Plantilla / Instrucciones</span>
          </div>
          <textarea 
            id="instructionsOutput" 
            class="flex-1 min-h-0 px-4 py-3 rounded-lg border border-[var(--bs-border-color)] bg-[var(--bs-tertiary-bg)] text-[var(--bs-body-color)] text-sm leading-relaxed whitespace-pre-wrap break-words resize-none outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-mono" 
            spellcheck="false"
            placeholder="Las instrucciones aparecerán aquí..."></textarea>
        </div>

        <!-- Right Panel: Result -->
        <div class="flex flex-col bg-[var(--bs-secondary-bg)] rounded-xl p-6 shadow-sm border border-[var(--bs-border-color)] min-h-0">
          <div class="flex items-center gap-2 text-base font-semibold text-[var(--bs-body-color)] mb-4 flex-shrink-0">
            <i id="outputIcon" class="fas fa-list text-blue-600"></i>
            <span id="outputTitle">Resultado</span>
          </div>
          <div 
            id="output" 
            class="flex-1 min-h-0 px-4 py-3 rounded-lg border border-[var(--bs-border-color)] bg-[var(--bs-tertiary-bg)] text-[var(--bs-body-color)] text-sm leading-relaxed whitespace-pre-wrap break-words overflow-y-auto">
        </div>
      </div>
    </div>
  </div>
  </main>

  <!-- Help Modal -->
  <div class="fixed inset-0 z-50 hidden" id="helpModal" tabindex="-1" aria-hidden="true">
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" id="modalBackdrop">
      <div class="bg-[var(--bs-body-bg)] rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between px-6 py-4 border-b border-[var(--bs-border-color)]">
          <h5 class="text-xl font-bold text-[var(--bs-heading-color)] flex items-center gap-2">
            <i class="fas fa-info-circle text-blue-600"></i>
            <span>Acerca de Teleprompter</span>
          </h5>
          <button type="button" class="p-2 rounded-lg hover:bg-[var(--bs-tertiary-bg)] transition-colors" id="closeHelpModal" aria-label="Close">
            <i class="fas fa-times text-[var(--bs-body-color)]"></i>
          </button>
        </div>
        <div class="px-6 py-5 overflow-y-auto flex-1">
          <p class="text-[var(--bs-body-color)] mb-4">
            <strong class="text-[var(--bs-heading-color)]">Teleprompter</strong> es un laboratorio avanzado de ingeniería de prompts diseñado para
            profesionales, investigadores y desarrolladores.
          </p>
          <hr class="border-[var(--bs-border-color)] my-4">
          <h6 class="text-lg font-semibold text-[var(--bs-heading-color)] mb-3 flex items-center gap-2">
            <i class="fas fa-bullseye text-blue-600"></i>
            <span>Objetivo de la Aplicación</span>
          </h6>
          <p class="text-[var(--bs-body-color)] mb-6">Facilitar la experimentación con técnicas modernas de comunicación con IAs, permitiendo transformar
            instrucciones básicas en prompts altamente efectivos y estructurados.</p>

          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mt-6">
            <h6 class="font-semibold text-amber-900 mb-2 flex items-center gap-2">
              <i class="fas fa-exclamation-triangle text-amber-600"></i>
              <span>Disclaimer Importante: Antipatrones</span>
            </h6>
            <p class="text-amber-800 text-sm mb-2">La sección de <strong>Antipatrones</strong> se incluye estrictamente con <strong>fines
                educativos y de investigación defensiva</strong>. Estos ejemplos ilustran vulnerabilidades de seguridad
              y patrones de ataque (como Jailbreaking o Prompt Leaking) para que los desarrolladores puedan aprender a
              proteger sus propios sistemas.</p>
            <p class="text-amber-800 text-sm">MgLab y el autor no se responsabilizan por el uso indebido de esta información fuera
              de entornos controlados de investigación.</p>
          </div>
        </div>
        <div class="px-6 py-4 border-t border-[var(--bs-border-color)] flex justify-end">
          <button type="button" class="px-6 py-2.5 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500" id="closeHelpModalBtn">Entendido</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Core Instructions and Tech/Strategies -->
  <script src={`${promptBase}generalInstructions.js`}></script>
  <script src={`${promptBase}techniques/priming.js`}></script>
  <script src={`${promptBase}techniques/zero-shot.js`}></script>
  <script src={`${promptBase}techniques/few-shot.js`}></script>
  <script src={`${promptBase}techniques/chain-of-thought.js`}></script>
  <script src={`${promptBase}techniques/zero-chain-of-thought.js`}></script>
  <script src={`${promptBase}techniques/role-playing.js`}></script>
  <script src={`${promptBase}techniques/iterative.js`}></script>
  <script src={`${promptBase}strategies/detalles.js`}></script>
  <script src={`${promptBase}strategies/rol.js`}></script>
  <script src={`${promptBase}strategies/delimitadores.js`}></script>
  <script src={`${promptBase}strategies/pasos.js`}></script>
  <script src={`${promptBase}strategies/ejemplos.js`}></script>
  <script src={`${promptBase}strategies/longitud.js`}></script>
  <script src={`${promptBase}strategies/referencia.js`}></script>
  <script src={`${promptBase}strategies/subtareas.js`}></script>
  <script src={`${promptBase}strategies/resumir-dialogos.js`}></script>
  <script src={`${promptBase}strategies/resumir-documentos.js`}></script>
  <script src={`${promptBase}strategies/tiempo-pensar.js`}></script>
  <script src={`${promptBase}strategies/perdio-algo.js`}></script>
  <script src={`${promptBase}strategies/componentes-4.js`}></script>
  <script src={`${promptBase}strategies/evitar-alucinaciones.js`}></script>
  <script src={`${promptBase}strategies/privacidad.js`}></script>
  <script src={`${promptBase}strategies/refinamiento-iterativo.js`}></script>
  <script src={`${promptBase}strategies/framework-completo.js`}></script>
  <script src={`${promptBase}strategies/division-gradual.js`}></script>
  <script src={`${promptBase}antipatterns/jailbreak.js`}></script>
  <script src={`${promptBase}antipatterns/personalidades-duales.js`}></script>
  <script src={`${promptBase}antipatterns/obra-teatro.js`}></script>
  <script src={`${promptBase}antipatterns/prefix-injection.js`}></script>
  <script src={`${promptBase}antipatterns/override-instrucciones.js`}></script>
  <script src={`${promptBase}antipatterns/negacion-inversa.js`}></script>
  <script src={`${promptBase}antipatterns/prompt-leaking.js`}></script>
  <script src={`${promptBase}antipatterns/escalacion-gradual.js`}></script>
  <script src={`${promptBase}antipatterns/fragmentacion.js`}></script>
  <script src={`${promptBase}antipatterns/encoding-ofuscacion.js`}></script>

  <!-- App logic -->
  <script src={`${promptBase}app.js`}></script>

  <script>
    // Apply theme immediately on page load
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
    })();

    // Initialize after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', function() {
          const currentTheme = document.documentElement.getAttribute('data-bs-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-bs-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          
          const icon = this.querySelector('i');
          if (icon) {
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
          }
        });
      }

      // Help modal
      const helpIcon = document.getElementById('helpIcon');
      const closeHelpModal = document.getElementById('closeHelpModal');
      const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
      const helpModal = document.getElementById('helpModal');
      const modalBackdrop = document.getElementById('modalBackdrop');
      
      function showModal() {
        if (helpModal) {
          helpModal.classList.remove('hidden');
          helpModal.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }
      
      function hideModal() {
        if (helpModal) {
          helpModal.classList.add('hidden');
          helpModal.classList.remove('show');
          document.body.style.overflow = '';
        }
      }
      
      if (helpIcon && helpModal) {
        helpIcon.addEventListener('click', showModal);
      }
      
      if (modalBackdrop) {
        modalBackdrop.addEventListener('click', function(e) {
          if (e.target === modalBackdrop) {
            hideModal();
          }
        });
      }

      if (closeHelpModal) {
        closeHelpModal.addEventListener('click', hideModal);
      }

      if (closeHelpModalBtn) {
        closeHelpModalBtn.addEventListener('click', hideModal);
      }
      
      // Close modal on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && helpModal && !helpModal.classList.contains('hidden')) {
          hideModal();
        }
      });

      // Sidebar search
      const sidebarSearch = document.getElementById('sidebarSearch');
      if (sidebarSearch && typeof window.filterSidebar === 'function') {
        sidebarSearch.addEventListener('input', window.filterSidebar);
      }

      // Generate button
      const genBtn = document.getElementById('genBtn');
      if (genBtn && typeof window.generateAll === 'function') {
        genBtn.addEventListener('click', window.generateAll);
      }
    });
  </script>
  </div>
</BaseTailwind>
