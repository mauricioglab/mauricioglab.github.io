---
import BaseTailwind from '../../layouts/BaseTailwind.astro';

export const prerender = true;
---

<BaseTailwind 
    title="üé¨ Video Organizer"
    description="Organizador de videos de YouTube y Udemy"
>
    <div class="min-h-screen flex flex-col" data-theme="dark">
    <!-- Header -->
    <header class="bg-bg-secondary border-b border-border-primary px-4 md:px-6 py-3 flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0 transition-all duration-300">
        <div class="flex items-center gap-3 md:gap-4">
            <h1 class="text-lg md:text-xl font-semibold text-text-primary">üé¨ Video Organizer</h1>
            <div class="w-px h-6 bg-border-primary hidden md:block"></div>
            <div class="flex gap-1 bg-bg-tertiary p-1 rounded-lg">
                <button id="board-view-btn" class="px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary active:bg-accent active:text-white active:shadow-sm">Tablero</button>
                <button id="list-view-btn" class="px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary active:bg-accent active:text-white active:shadow-sm">Lista</button>
            </div>
        </div>
        <div class="flex items-center gap-2 md:gap-3 flex-wrap">
            <div class="relative">
                <input type="text" id="search-input" class="px-3 py-2 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm w-[150px] md:w-[200px] transition-all duration-200 focus:outline-none focus:border-accent" placeholder="Buscar videos...">
            </div>
            <button id="add-video-btn" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+ Agregar Video</button>
            <button id="export-btn" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary" title="Exportar">üì•</button>
            <button id="import-btn" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary" title="Importar">üì§</button>
            <div class="w-px h-6 bg-border-primary hidden md:block"></div>
            <button id="theme-toggle" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary" title="Cambiar tema">üåô</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-full md:w-70 bg-bg-secondary border-r border-border-primary flex flex-col transition-all duration-300 md:h-auto h-[200px]">
            <div class="p-3 md:p-4 border-b border-border-primary">
                <div class="flex gap-2">
                    <input type="text" id="category-input" class="flex-1 px-3 py-2 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm focus:outline-none focus:border-accent" placeholder="Nueva categor√≠a">
                    <button id="add-category-btn" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3 md:p-4">
                <h2 class="text-sm font-semibold text-text-secondary mb-3 uppercase tracking-wider">Categor√≠as</h2>
                <ul id="categories-list" class="flex flex-col gap-2 list-none">
                    <!-- Categor√≠as se cargan din√°micamente -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-6 overflow-y-auto">
            <!-- Board View -->
            <div id="board-view" class="grid grid-cols-1 md:grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-4 items-start">
                <!-- Columnas de categor√≠as se cargan din√°micamente -->
            </div>

            <!-- List View -->
            <div id="list-view" class="grid grid-cols-1 md:grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-4 hidden">
                <!-- Videos en lista se cargan din√°micamente -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex flex-col items-center justify-center py-[60px] px-5 text-center hidden">
                <div class="text-[64px] mb-4 opacity-50">üìÅ</div>
                <h3 class="text-xl font-semibold text-text-primary mb-2">No hay categor√≠as</h3>
                <p class="text-sm text-text-muted mb-6">Crea una categor√≠a para empezar a organizar tus videos</p>
                <button id="create-first-category" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">Crear primera categor√≠a</button>
            </div>
        </main>
    </div>

    <!-- Modal para agregar video -->
    <div id="add-video-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[1000] p-5 hidden">
        <div class="bg-bg-secondary rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center p-5 border-b border-border-primary">
                <h2 class="text-xl font-semibold text-text-primary">Agregar Video</h2>
                <button id="close-video-modal" class="bg-transparent border-none text-2xl text-text-muted cursor-pointer p-0 w-8 h-8 flex items-center justify-center rounded transition-all duration-200 hover:bg-bg-tertiary hover:text-text-primary">√ó</button>
            </div>
            <form id="add-video-form">
                <div class="mb-5 px-5">
                    <label class="block text-sm font-medium text-text-primary mb-2">URL del Video (YouTube o Udemy)</label>
                    <input type="text" id="video-url" class="w-full px-3 py-2.5 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm transition-all duration-200 focus:outline-none focus:border-accent" placeholder="https://www.youtube.com/watch?v=...">
                    <div id="url-error" class="text-error text-xs mt-1 px-2 py-1 bg-error/10 border border-error rounded hidden"></div>
                </div>
                <div class="mb-5 px-5">
                    <label class="block text-sm font-medium text-text-primary mb-2">Categor√≠a</label>
                    <select id="video-category" class="w-full px-3 py-2.5 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm transition-all duration-200 focus:outline-none focus:border-accent">
                        <option value="">Selecciona una categor√≠a</option>
                    </select>
                </div>
                <div class="mb-5 px-5">
                    <label class="block text-sm font-medium text-text-primary mb-2">Comentarios (opcional)</label>
                    <textarea id="video-comments" class="w-full px-3 py-2.5 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm transition-all duration-200 focus:outline-none focus:border-accent resize-y min-h-[100px]" placeholder="Notas personales sobre este video..."></textarea>
                </div>
                <div class="flex justify-end gap-3 p-5 border-t border-border-primary">
                    <button type="button" id="cancel-video" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary">Cancelar</button>
                    <button type="submit" id="save-video" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Video Player -->
    <div id="video-player" class="fixed inset-0 bg-black/95 z-[2000] flex flex-col md:flex-row hidden">
        <div class="flex-1 flex flex-col p-4 md:p-6">
            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h2 id="player-title" class="text-lg md:text-2xl font-semibold text-white"></h2>
                <button id="close-player" class="bg-transparent border-none text-2xl text-text-muted cursor-pointer p-0 w-8 h-8 flex items-center justify-center rounded transition-all duration-200 hover:bg-bg-tertiary hover:text-text-primary">√ó</button>
            </div>
            <div class="flex-1 flex flex-col gap-4 md:gap-6">
                <div class="flex-1 min-h-0">
                    <iframe id="player-iframe" class="w-full h-full border-none rounded-lg" frameborder="0" allowfullscreen></iframe>
                </div>
                <div id="player-comments" class="text-xs text-text-muted mt-2 italic hidden"></div>
            </div>
        </div>
        <div class="w-full md:w-80 h-[200px] md:h-auto bg-black/90 p-4 md:p-6 overflow-y-auto border-t md:border-t-0 md:border-l border-border-primary">
            <div class="mb-8">
                <h3 class="text-sm font-semibold text-text-secondary mb-3 uppercase tracking-wider">Todos los Videos</h3>
                <div id="player-video-list">
                    <!-- Lista de videos se carga din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script is:inline>
        // Constantes y configuraci√≥n
        const STORAGE_KEY = 'video-organizer-data';
        const YOUTUBE_REGEX = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const YOUTUBE_PLAYLIST_REGEX = /(?:youtube\.com\/playlist\?list=|youtube\.com\/.*[?&]list=)([a-zA-Z0-9_-]+)/;
        const UDEMY_REGEX = /udemy\.com\/course\/[^\/]+\/learn\/lecture\/(\d+)/;

        // Estado de la aplicaci√≥n
        let appState = {
            categories: [],
            currentView: 'board',
            selectedVideo: null,
            currentTheme: 'dark',
            searchQuery: ''
        };

        // Elementos del DOM
        const elements = {
            boardViewBtn: document.getElementById('board-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            boardView: document.getElementById('board-view'),
            listView: document.getElementById('list-view'),
            emptyState: document.getElementById('empty-state'),
            categoriesList: document.getElementById('categories-list'),
            categoryInput: document.getElementById('category-input'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            addVideoBtn: document.getElementById('add-video-btn'),
            addVideoModal: document.getElementById('add-video-modal'),
            closeVideoModal: document.getElementById('close-video-modal'),
            addVideoForm: document.getElementById('add-video-form'),
            videoUrl: document.getElementById('video-url'),
            videoCategory: document.getElementById('video-category'),
            videoComments: document.getElementById('video-comments'),
            cancelVideo: document.getElementById('cancel-video'),
            saveVideo: document.getElementById('save-video'),
            urlError: document.getElementById('url-error'),
            searchInput: document.getElementById('search-input'),
            themeToggle: document.getElementById('theme-toggle'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            videoPlayer: document.getElementById('video-player'),
            playerTitle: document.getElementById('player-title'),
            playerIframe: document.getElementById('player-iframe'),
            playerComments: document.getElementById('player-comments'),
            closePlayer: document.getElementById('close-player'),
            playerVideoList: document.getElementById('player-video-list'),
            createFirstCategory: document.getElementById('create-first-category')
        };

        // Utilidades
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
            } catch (error) {
                console.error('Error saving to storage:', error);
            }
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    appState = { ...appState, ...data };
                }
            } catch (error) {
                console.error('Error loading from storage:', error);
            }
        }

        function validateVideoUrl(url) {
            if (!url || typeof url !== 'string') return null;

            const playlistMatch = url.match(YOUTUBE_PLAYLIST_REGEX);
            if (playlistMatch && playlistMatch[1]) {
                return {
                    platform: 'youtube-playlist',
                    playlistId: playlistMatch[1]
                };
            }

            const youtubeMatch = url.match(YOUTUBE_REGEX);
            if (youtubeMatch && youtubeMatch[1]) {
                return {
                    platform: 'youtube',
                    videoId: youtubeMatch[1]
                };
            }

            const udemyMatch = url.match(UDEMY_REGEX);
            if (udemyMatch && udemyMatch[1]) {
                return {
                    platform: 'udemy',
                    videoId: udemyMatch[1]
                };
            }

            return null;
        }

        function getEmbedUrl(url, platform, videoId) {
            if (platform === 'youtube') {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            if (platform === 'udemy') {
                return url; // Udemy requiere autenticaci√≥n
            }
            return null;
        }

        function getThumbnailUrl(videoId, platform) {
            if (platform === 'youtube' && videoId) {
                return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            }
            return null;
        }

        async function fetchVideoTitle(url, platform) {
            try {
                if (platform === 'youtube') {
                    const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;
                    const response = await fetch(oembedUrl);
                    if (response.ok) {
                        const data = await response.json();
                        return data.title || 'Video de YouTube';
                    }
                }
            } catch (error) {
                console.error('Error fetching video title:', error);
            }
            
            if (platform === 'youtube') return 'Video de YouTube';
            if (platform === 'udemy') return 'Video de Udemy';
            return 'Video';
        }

        async function createVideoObject(url, comments = '') {
            const validation = validateVideoUrl(url);
            if (!validation) {
                throw new Error('URL de video no v√°lida');
            }

            const { platform, videoId, playlistId } = validation;
            const title = await fetchVideoTitle(url, platform);
            const thumbnail = getThumbnailUrl(videoId, platform);

            return {
                id: generateId(),
                url,
                platform: platform === 'youtube-playlist' ? 'youtube' : platform,
                videoId,
                playlistId,
                isPlaylist: platform === 'youtube-playlist',
                title,
                thumbnail,
                comments,
                createdAt: Date.now()
            };
        }

        // Funciones de renderizado
        function renderCategories() {
            const container = elements.categoriesList;
            container.innerHTML = '';

            if (appState.categories.length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.boardView.classList.add('hidden');
                elements.listView.classList.add('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            if (appState.currentView === 'board') {
                elements.boardView.classList.remove('hidden');
                elements.listView.classList.add('hidden');
            } else {
                elements.boardView.classList.add('hidden');
                elements.listView.classList.remove('hidden');
            }

            appState.categories.forEach(category => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-bg-tertiary rounded-lg flex justify-between items-center cursor-pointer transition-all duration-200 hover:bg-border-primary';
                li.innerHTML = `
                    <div>
                        <div class="font-medium text-text-primary mb-1">${category.name}</div>
                        <div class="text-xs text-text-muted">${category.videos.length} videos</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCategory('${category.id}')" class="bg-transparent border-none cursor-pointer text-base p-1 opacity-60 transition-opacity duration-200 hover:opacity-100" title="Editar">‚úèÔ∏è</button>
                        <button onclick="deleteCategory('${category.id}')" class="bg-transparent border-none cursor-pointer text-base p-1 opacity-60 transition-opacity duration-200 hover:opacity-100" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(li);
            });

            // Actualizar select de categor√≠as en el modal
            updateCategorySelect();
        }

        function updateCategorySelect() {
            const select = elements.videoCategory;
            select.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
            
            appState.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        function renderBoardView() {
            const container = elements.boardView;
            container.innerHTML = '';

            const filteredCategories = getFilteredCategories();

            filteredCategories.forEach(category => {
                const column = document.createElement('div');
                column.className = 'bg-bg-secondary rounded-lg p-4 min-w-[280px]';
                column.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-semibold text-text-primary">${category.name}</h3>
                        <button onclick="addVideoToCategory('${category.id}')" class="px-2 py-1 rounded-lg text-xs font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+</button>
                    </div>
                    <div class="flex flex-col gap-3" id="videos-${category.id}">
                        ${category.videos.map(video => renderVideoCard(video)).join('')}
                    </div>
                `;
                container.appendChild(column);
            });
        }

        function renderListView() {
            const container = elements.listView;
            container.innerHTML = '';

            const allVideos = appState.categories.flatMap(cat => 
                cat.videos.map(video => ({ ...video, categoryName: cat.name }))
            );

            const filteredVideos = getFilteredVideos(allVideos);

            filteredVideos.forEach(video => {
                const card = document.createElement('div');
                card.innerHTML = renderVideoCard(video, true);
                container.appendChild(card.firstElementChild);
            });
        }

        function renderVideoCard(video, showCategory = false) {
            const thumbnailHtml = video.thumbnail 
                ? `<img src="${video.thumbnail}" alt="${video.title}" class="absolute top-0 left-0 w-full h-full object-cover" onerror="this.style.display='none'">`
                : `<div class="absolute inset-0 flex items-center justify-center text-text-muted">
                     ${video.isPlaylist ? 'üìã' : 'üé¨'}
                   </div>`;

            const platformBg = video.platform === 'youtube' ? 'bg-red-500/10 text-red-500' : 'bg-black/10 text-text-primary';
            
            return `
                <div class="bg-bg-tertiary rounded-lg overflow-hidden cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg group" onclick="playVideo('${video.id}')">
                    <div class="relative w-full pt-[56.25%] bg-bg-primary overflow-hidden">
                        ${thumbnailHtml}
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <button class="bg-accent text-white border-none px-4 py-2 rounded-md font-medium cursor-pointer">‚ñ∂ Reproducir</button>
                        </div>
                    </div>
                    <div class="p-3">
                        <h4 class="text-sm font-medium text-text-primary mb-2 line-clamp-2">${video.title}</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-xs px-2 py-1 rounded font-medium ${platformBg}">
                                ${video.platform === 'youtube' ? 'YouTube' : 'Udemy'}
                                ${video.isPlaylist ? ' Playlist' : ''}
                            </span>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); editVideo('${video.id}')" class="bg-transparent border-none cursor-pointer text-sm opacity-60 transition-opacity duration-200 hover:opacity-100" title="Editar">‚úèÔ∏è</button>
                                <button onclick="event.stopPropagation(); deleteVideo('${video.id}')" class="bg-transparent border-none cursor-pointer text-sm opacity-60 transition-opacity duration-200 hover:opacity-100" title="Eliminar">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${showCategory ? `<div class="text-xs text-text-muted mt-1">${video.categoryName}</div>` : ''}
                        ${video.comments ? `<div class="text-xs text-text-muted mt-2 italic">${video.comments}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function getFilteredCategories() {
            if (!appState.searchQuery) return appState.categories;
            
            return appState.categories.filter(category => {
                const categoryMatch = category.name.toLowerCase().includes(appState.searchQuery.toLowerCase());
                const videoMatch = category.videos.some(video => 
                    video.title.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
                    (video.comments && video.comments.toLowerCase().includes(appState.searchQuery.toLowerCase()))
                );
                return categoryMatch || videoMatch;
            }).map(category => ({
                ...category,
                videos: category.videos.filter(video =>
                    video.title.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
                    (video.comments && video.comments.toLowerCase().includes(appState.searchQuery.toLowerCase()))
                )
            }));
        }

        function getFilteredVideos(videos) {
            if (!appState.searchQuery) return videos;
            
            return videos.filter(video =>
                video.title.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
                (video.comments && video.comments.toLowerCase().includes(appState.searchQuery.toLowerCase())) ||
                video.categoryName.toLowerCase().includes(appState.searchQuery.toLowerCase())
            );
        }

        // Funciones de la aplicaci√≥n
        function addCategory() {
            if (!elements.categoryInput) return;
            const name = elements.categoryInput.value.trim();
            if (!name) return;

            const newCategory = {
                id: generateId(),
                name: name,
                videos: []
            };

            appState.categories.push(newCategory);
            elements.categoryInput.value = '';
            saveToStorage();
            render();
        }

        function deleteCategory(categoryId) {
            if (!confirm('¬øEliminar esta categor√≠a y todos sus videos?')) return;
            
            appState.categories = appState.categories.filter(cat => cat.id !== categoryId);
            saveToStorage();
            render();
        }

        function editCategory(categoryId) {
            const category = appState.categories.find(cat => cat.id === categoryId);
            if (!category) return;

            const newName = prompt('Nuevo nombre de la categor√≠a:', category.name);
            if (newName && newName.trim()) {
                category.name = newName.trim();
                saveToStorage();
                render();
            }
        }

        function showAddVideoModal(categoryId) {
            if (categoryId === undefined) categoryId = null;
            if (elements.addVideoModal) {
                elements.addVideoModal.classList.remove('hidden');
            }
            if (categoryId && elements.videoCategory) {
                elements.videoCategory.value = categoryId;
            }
            if (elements.videoUrl) {
                elements.videoUrl.focus();
            }
        }

        function hideAddVideoModal() {
            if (elements.addVideoModal) {
                elements.addVideoModal.classList.add('hidden');
            }
            if (elements.addVideoForm) {
                elements.addVideoForm.reset();
            }
            if (elements.urlError) {
                elements.urlError.classList.add('hidden');
            }
        }

        async function addVideo() {
            if (!elements.videoUrl || !elements.videoCategory || !elements.videoComments) return;
            
            const url = elements.videoUrl.value.trim();
            const categoryId = elements.videoCategory.value;
            const comments = elements.videoComments.value.trim();

            if (!url) {
                showError('Por favor ingresa una URL');
                return;
            }

            if (!validateVideoUrl(url)) {
                showError('URL no v√°lida. Debe ser de YouTube o Udemy.');
                return;
            }

            if (!categoryId) {
                showError('Por favor selecciona una categor√≠a');
                return;
            }

            try {
                if (elements.saveVideo) {
                    elements.saveVideo.textContent = 'Agregando...';
                    elements.saveVideo.disabled = true;
                }

                const videoData = await createVideoObject(url, comments);
                const category = appState.categories.find(cat => cat.id === categoryId);
                
                if (category) {
                    category.videos.push(videoData);
                    saveToStorage();
                    render();
                    hideAddVideoModal();
                }
            } catch (error) {
                showError((error && error.message) || 'Error al agregar el video');
            } finally {
                if (elements.saveVideo) {
                    elements.saveVideo.textContent = 'Agregar';
                    elements.saveVideo.disabled = false;
                }
            }
        }

        function showError(message) {
            if (elements.urlError) {
                elements.urlError.textContent = message;
                elements.urlError.classList.remove('hidden');
            }
        }

        function deleteVideo(videoId) {
            if (!confirm('¬øEliminar este video?')) return;

            appState.categories.forEach(category => {
                category.videos = category.videos.filter(video => video.id !== videoId);
            });

            saveToStorage();
            render();
        }

        function editVideo(videoId) {
            const video = findVideoById(videoId);
            if (!video) return;

            const newComments = prompt('Comentarios:', video.comments || '');
            if (newComments !== null) {
                video.comments = newComments.trim();
                saveToStorage();
                render();
            }
        }

        function findVideoById(videoId) {
            for (const category of appState.categories) {
                const video = category.videos.find(v => v.id === videoId);
                if (video) return video;
            }
            return null;
        }

        function playVideo(videoId) {
            const video = findVideoById(videoId);
            if (!video) return;

            appState.selectedVideo = video;
            elements.playerTitle.textContent = video.title;
            
            const embedUrl = getEmbedUrl(video.url, video.platform, video.videoId);
            if (embedUrl && video.platform === 'youtube') {
                elements.playerIframe.src = embedUrl;
            } else {
                elements.playerIframe.src = '';
                // Para Udemy, mostrar enlace
                elements.playerIframe.style.display = 'none';
                const playerVideo = document.querySelector('.flex-1.min-h-0');
                if (playerVideo) {
                    playerVideo.innerHTML = `
                        <div class="flex items-center justify-center h-full bg-black text-white text-center p-5">
                            <div>
                                <p class="mb-4">Los videos de Udemy requieren autenticaci√≥n</p>
                                <a href="${video.url}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">Abrir en Udemy</a>
                            </div>
                        </div>
                    `;
                }
            }

            if (video.comments) {
                elements.playerComments.textContent = video.comments;
                elements.playerComments.classList.remove('hidden');
            } else {
                elements.playerComments.classList.add('hidden');
            }

            renderPlayerVideoList();
            elements.videoPlayer.classList.remove('hidden');
        }

        function renderPlayerVideoList() {
            const container = elements.playerVideoList;
            container.innerHTML = '';

            const allVideos = appState.categories.flatMap(cat => 
                cat.videos.map(video => ({ ...video, categoryName: cat.name }))
            );

            allVideos.forEach(video => {
                const item = document.createElement('div');
                const isActive = video.id === appState.selectedVideo?.id;
                item.className = `p-3 rounded-lg mb-2 cursor-pointer transition-all duration-200 ${isActive ? 'bg-accent text-white' : 'bg-white/5 hover:bg-white/10'}`;
                item.onclick = () => playVideo(video.id);
                item.innerHTML = `
                    <div class="text-sm font-medium mb-1">${video.title}</div>
                    <div class="text-xs opacity-70">${video.categoryName}</div>
                `;
                container.appendChild(item);
            });
        }

        function closeVideoPlayer() {
            elements.videoPlayer.classList.add('hidden');
            elements.playerIframe.src = '';
            appState.selectedVideo = null;
        }

        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', appState.currentTheme);
            if (elements.themeToggle) {
                elements.themeToggle.textContent = appState.currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                elements.themeToggle.title = appState.currentTheme === 'dark' ? 'Modo claro' : 'Modo oscuro';
            }
            saveToStorage();
        }

        function setView(view) {
            appState.currentView = view;
            // Actualizar clases Tailwind para botones activos
            if (view === 'board') {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
            } else {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
            }
            saveToStorage();
            render();
        }

        function handleSearch() {
            if (elements.searchInput) {
                appState.searchQuery = elements.searchInput.value.trim();
                render();
            }
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(appState, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'video-organizer-backup.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error al exportar datos: ' + error.message);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.categories && Array.isArray(data.categories)) {
                            if (confirm('¬øImportar estos datos? Se reemplazar√°n los datos actuales.')) {
                                appState = { ...appState, ...data };
                                saveToStorage();
                                render();
                                alert('Datos importados correctamente');
                            }
                        } else {
                            alert('Formato de archivo inv√°lido');
                        }
                    } catch (error) {
                        alert('Error al importar: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function render() {
            renderCategories();
            if (appState.currentView === 'board') {
                renderBoardView();
            } else {
                renderListView();
            }
        }

        // Funciones globales para eventos onclick
        window.addVideoToCategory = function(categoryId) { showAddVideoModal(categoryId); };
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.deleteVideo = deleteVideo;
        window.editVideo = editVideo;
        window.playVideo = playVideo;

        // Funci√≥n para registrar event listeners
        function setupEventListeners() {
            // Event listeners
            if (elements.boardViewBtn) {
                elements.boardViewBtn.addEventListener('click', () => setView('board'));
            }
            if (elements.listViewBtn) {
                elements.listViewBtn.addEventListener('click', () => setView('list'));
            }
            if (elements.addCategoryBtn) {
                elements.addCategoryBtn.addEventListener('click', addCategory);
            }
            if (elements.categoryInput) {
                elements.categoryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addCategory();
                });
            }
            if (elements.addVideoBtn) {
                elements.addVideoBtn.addEventListener('click', () => showAddVideoModal());
            }
            if (elements.closeVideoModal) {
                elements.closeVideoModal.addEventListener('click', hideAddVideoModal);
            }
            if (elements.cancelVideo) {
                elements.cancelVideo.addEventListener('click', hideAddVideoModal);
            }
            if (elements.addVideoForm) {
                elements.addVideoForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    addVideo();
                });
            }
            if (elements.searchInput) {
                elements.searchInput.addEventListener('input', handleSearch);
            }
            if (elements.themeToggle) {
                elements.themeToggle.addEventListener('click', toggleTheme);
            }
            if (elements.exportBtn) {
                elements.exportBtn.addEventListener('click', exportData);
            }
            if (elements.importBtn) {
                elements.importBtn.addEventListener('click', importData);
            }
            if (elements.closePlayer) {
                elements.closePlayer.addEventListener('click', closeVideoPlayer);
            }
            if (elements.createFirstCategory) {
                elements.createFirstCategory.addEventListener('click', () => {
                    if (elements.categoryInput) {
                        elements.categoryInput.focus();
                    }
                });
            }

            // Cerrar modales con Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (elements.addVideoModal && !elements.addVideoModal.classList.contains('hidden')) {
                        hideAddVideoModal();
                    }
                    if (elements.videoPlayer && !elements.videoPlayer.classList.contains('hidden')) {
                        closeVideoPlayer();
                    }
                }
            });

            // Cerrar modales clickeando fuera
            if (elements.addVideoModal) {
                elements.addVideoModal.addEventListener('click', (e) => {
                    if (e.target === elements.addVideoModal) {
                        hideAddVideoModal();
                    }
                });
            }

            if (elements.videoPlayer) {
                elements.videoPlayer.addEventListener('click', (e) => {
                    if (e.target === elements.videoPlayer) {
                        closeVideoPlayer();
                    }
                });
            }
        }

        // Inicializaci√≥n
        function init() {
            // Re-obtener elementos del DOM por si acaso
            elements.boardViewBtn = document.getElementById('board-view-btn');
            elements.listViewBtn = document.getElementById('list-view-btn');
            elements.addVideoBtn = document.getElementById('add-video-btn');
            elements.addCategoryBtn = document.getElementById('add-category-btn');
            elements.categoryInput = document.getElementById('category-input');
            elements.searchInput = document.getElementById('search-input');
            elements.themeToggle = document.getElementById('theme-toggle');
            elements.addVideoModal = document.getElementById('add-video-modal');
            elements.closeVideoModal = document.getElementById('close-video-modal');
            elements.cancelVideo = document.getElementById('cancel-video');
            elements.addVideoForm = document.getElementById('add-video-form');
            elements.videoUrl = document.getElementById('video-url');
            elements.videoCategory = document.getElementById('video-category');
            elements.videoComments = document.getElementById('video-comments');
            elements.saveVideo = document.getElementById('save-video');
            elements.urlError = document.getElementById('url-error');
            elements.exportBtn = document.getElementById('export-btn');
            elements.importBtn = document.getElementById('import-btn');
            elements.videoPlayer = document.getElementById('video-player');
            elements.closePlayer = document.getElementById('close-player');
            elements.playerTitle = document.getElementById('player-title');
            elements.playerIframe = document.getElementById('player-iframe');
            elements.playerComments = document.getElementById('player-comments');
            elements.playerVideoList = document.getElementById('player-video-list');
            elements.createFirstCategory = document.getElementById('create-first-category');
            elements.boardView = document.getElementById('board-view');
            elements.listView = document.getElementById('list-view');
            elements.emptyState = document.getElementById('empty-state');
            elements.categoriesList = document.getElementById('categories-list');

            loadFromStorage();
            document.body.setAttribute('data-theme', appState.currentTheme);
            if (elements.themeToggle) {
                elements.themeToggle.textContent = appState.currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                elements.themeToggle.title = appState.currentTheme === 'dark' ? 'Modo claro' : 'Modo oscuro';
            }
            // Inicializar clases de botones de vista
            if (appState.currentView === 'board') {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
            } else {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
            }
            
            // Configurar event listeners
            setupEventListeners();
            
            render();
        }

        // Iniciar la aplicaci√≥n cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // Si el DOM ya est√° listo, ejecutar inmediatamente
            setTimeout(init, 0);
        }
    </script>
    </div>
</BaseTailwind>
