---
import BaseTailwind from '../../layouts/BaseTailwind.astro';

export const prerender = true;
---

<BaseTailwind 
    title="üé¨ Video Organizer"
    description="Organizador de videos de YouTube y Udemy"
>
    <div id="video-organizer-root" class="min-h-screen flex flex-col" data-theme="dark">
    <!-- Header -->
    <header class="bg-bg-secondary border-b border-border-primary px-4 md:px-6 py-3 flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0 transition-all duration-300">
        <div class="flex items-center gap-3 md:gap-4">
            <h1 class="text-lg md:text-xl font-semibold text-text-primary">üé¨ Video Organizer</h1>
            <div class="w-px h-6 bg-border-primary hidden md:block"></div>
            <div class="flex gap-1 bg-bg-tertiary p-1 rounded-lg">
                <button id="board-view-btn" class="px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary active:bg-accent active:text-white active:shadow-sm">Tablero</button>
                <button id="list-view-btn" class="px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary active:bg-accent active:text-white active:shadow-sm">Lista</button>
            </div>
        </div>
        <div class="flex items-center gap-2 md:gap-3 flex-wrap">
            <div id="selection-actions" class="hidden flex items-center gap-2">
                <span id="selection-count" class="text-sm text-text-muted"></span>
                <button id="delete-selected-btn" class="px-3 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-red-600 text-white hover:bg-red-700">Eliminar seleccionados</button>
                <button id="clear-selection-btn" class="px-3 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary">Cancelar</button>
            </div>
            <div class="relative">
                <input type="text" id="search-input" class="px-3 py-2 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm w-[150px] md:w-[200px] transition-all duration-200 focus:outline-none focus:border-accent" placeholder="Buscar videos...">
            </div>
            <button id="add-video-btn" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+ Agregar Video</button>
            <button id="export-btn" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary" title="Exportar">üì•</button>
            <button id="import-btn" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary" title="Importar">üì§</button>
            <div class="w-px h-6 bg-border-primary hidden md:block"></div>
            <button id="theme-toggle" class="px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary" title="Cambiar tema">üåô</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-full md:w-70 bg-bg-secondary border-r border-border-primary flex flex-col transition-all duration-300 md:h-auto h-[200px]">
            <div class="p-3 md:p-4 border-b border-border-primary">
                <div class="flex gap-2">
                    <input type="text" id="category-input" class="flex-1 px-3 py-2 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm focus:outline-none focus:border-accent" placeholder="Nueva categor√≠a">
                    <button id="add-category-btn" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3 md:p-4">
                <h2 class="text-sm font-semibold text-text-secondary mb-3 uppercase tracking-wider">Categor√≠as</h2>
                <ul id="categories-list" class="flex flex-col gap-2 list-none">
                    <!-- Categor√≠as se cargan din√°micamente -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-6 overflow-y-auto">
            <!-- Board View -->
            <div id="board-view" class="grid grid-cols-1 md:grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-4 items-start">
                <!-- Columnas de categor√≠as se cargan din√°micamente -->
            </div>

            <!-- List View (categor√≠as desplegables) -->
            <div id="list-view" class="flex flex-col gap-4 hidden">
                <!-- Secciones por categor√≠a se cargan din√°micamente -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex flex-col items-center justify-center py-[60px] px-5 text-center hidden">
                <div class="text-[64px] mb-4 opacity-50">üìÅ</div>
                <h3 class="text-xl font-semibold text-text-primary mb-2">No hay categor√≠as</h3>
                <p class="text-sm text-text-muted mb-6">Crea una categor√≠a para empezar a organizar tus videos</p>
                <button id="create-first-category" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">Crear primera categor√≠a</button>
            </div>
        </main>
    </div>

    <!-- Modal para agregar video -->
    <div id="add-video-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[1000] p-5 hidden">
        <div class="bg-bg-secondary rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center p-5 border-b border-border-primary">
                <h2 class="text-xl font-semibold text-text-primary">Agregar Video</h2>
                <button id="close-video-modal" class="bg-transparent border-none text-2xl text-text-muted cursor-pointer p-0 w-8 h-8 flex items-center justify-center rounded transition-all duration-200 hover:bg-bg-tertiary hover:text-text-primary">√ó</button>
            </div>
            <form id="add-video-form">
                <div class="mb-5 px-5">
                    <label class="block text-sm font-medium text-text-primary mb-2">URL del Video (YouTube o Udemy)</label>
                    <input type="text" id="video-url" class="w-full px-3 py-2.5 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm transition-all duration-200 focus:outline-none focus:border-accent" placeholder="https://www.youtube.com/watch?v=...">
                    <div id="url-error" class="text-error text-xs mt-1 px-2 py-1 bg-error/10 border border-error rounded hidden"></div>
                </div>
                <div class="mb-5 px-5">
                    <label class="block text-sm font-medium text-text-primary mb-2">Categor√≠a</label>
                    <select id="video-category" class="w-full px-3 py-2.5 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm transition-all duration-200 focus:outline-none focus:border-accent">
                        <option value="">Selecciona una categor√≠a</option>
                    </select>
                </div>
                <div class="mb-5 px-5">
                    <label class="block text-sm font-medium text-text-primary mb-2">Comentarios (opcional)</label>
                    <textarea id="video-comments" class="w-full px-3 py-2.5 border border-border-primary rounded-lg bg-bg-tertiary text-text-primary text-sm transition-all duration-200 focus:outline-none focus:border-accent resize-y min-h-[100px]" placeholder="Notas personales sobre este video..."></textarea>
                </div>
                <div class="flex justify-end gap-3 p-5 border-t border-border-primary">
                    <button type="button" id="cancel-video" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-bg-tertiary text-text-primary border border-border-primary hover:bg-border-primary">Cancelar</button>
                    <button type="submit" id="save-video" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lista de videos (playlist) -->
    <div id="playlist-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[1500] p-5 hidden">
        <div class="bg-bg-secondary rounded-xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center p-5 border-b border-border-primary shrink-0">
                <h2 id="playlist-modal-title" class="text-xl font-semibold text-text-primary truncate pr-4"></h2>
                <button id="close-playlist-modal" class="bg-transparent border-none text-2xl text-text-muted cursor-pointer p-0 w-8 h-8 flex items-center justify-center rounded transition-all duration-200 hover:bg-bg-tertiary hover:text-text-primary shrink-0">√ó</button>
            </div>
            <div id="playlist-modal-body" class="flex-1 overflow-y-auto p-5">
                <div id="playlist-modal-loading" class="flex flex-col items-center justify-center py-12 text-text-muted hidden">
                    <div class="animate-pulse text-4xl mb-4">‚è≥</div>
                    <p class="text-sm">Cargando videos...</p>
                </div>
                <div id="playlist-modal-error" class="flex flex-col items-center justify-center py-12 text-center hidden">
                    <div class="text-4xl mb-4 opacity-60">‚ö†Ô∏è</div>
                    <p id="playlist-modal-error-msg" class="text-sm text-text-primary mb-4"></p>
                    <a id="playlist-modal-open-yt" href="#" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover hidden">Abrir en YouTube</a>
                </div>
                <div id="playlist-modal-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 hidden">
                    <!-- Videos de la lista se cargan din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Video Player -->
    <div id="video-player" class="fixed inset-0 bg-black/95 z-[2000] flex flex-col md:flex-row hidden">
        <div class="flex-1 flex flex-col p-4 md:p-6">
            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h2 id="player-title" class="text-lg md:text-2xl font-semibold text-white"></h2>
                <button id="close-player" class="bg-transparent border-none text-2xl text-text-muted cursor-pointer p-0 w-8 h-8 flex items-center justify-center rounded transition-all duration-200 hover:bg-bg-tertiary hover:text-text-primary">√ó</button>
            </div>
            <div class="flex-1 flex flex-col gap-4 md:gap-6">
                <div class="flex-1 min-h-0">
                    <iframe id="player-iframe" class="w-full h-full border-none rounded-lg" frameborder="0" allowfullscreen></iframe>
                </div>
                <div id="player-comments" class="text-xs text-text-muted mt-2 italic hidden"></div>
            </div>
        </div>
        <div class="w-full md:w-80 h-[200px] md:h-auto bg-black/90 p-4 md:p-6 overflow-y-auto border-t md:border-t-0 md:border-l border-border-primary">
            <div class="mb-8">
                <h3 class="text-sm font-semibold text-text-secondary mb-3 uppercase tracking-wider">Todos los Videos</h3>
                <div id="player-video-list">
                    <!-- Lista de videos se carga din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script is:inline>
        // Constantes y configuraci√≥n
        const STORAGE_KEY = 'video-organizer-data';
        const PLAYLIST_CACHE_KEY = 'video-organizer-playlist-cache';
        const YOUTUBE_REGEX = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const YOUTUBE_PLAYLIST_REGEX = /(?:youtube\.com\/playlist\?list=|youtube\.com\/.*[?&]list=)([a-zA-Z0-9_-]+)/;
        const UDEMY_REGEX = /udemy\.com\/course\/[^\/]+\/learn\/lecture\/(\d+)/;

        // Estado de la aplicaci√≥n
        let appState = {
            categories: [],
            currentView: 'board',
            selectedVideo: null,
            currentTheme: 'dark',
            searchQuery: '',
            expandedCategories: {},
            selectedVideoIds: []
        };

        // Cache de listas: { [playlistId]: { items: { videoId, title, thumbnail }[], fetchedAt } }
        let playlistCache = {};

        // Elementos del DOM
        const elements = {
            boardViewBtn: document.getElementById('board-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            boardView: document.getElementById('board-view'),
            listView: document.getElementById('list-view'),
            emptyState: document.getElementById('empty-state'),
            categoriesList: document.getElementById('categories-list'),
            categoryInput: document.getElementById('category-input'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            addVideoBtn: document.getElementById('add-video-btn'),
            addVideoModal: document.getElementById('add-video-modal'),
            closeVideoModal: document.getElementById('close-video-modal'),
            addVideoForm: document.getElementById('add-video-form'),
            videoUrl: document.getElementById('video-url'),
            videoCategory: document.getElementById('video-category'),
            videoComments: document.getElementById('video-comments'),
            cancelVideo: document.getElementById('cancel-video'),
            saveVideo: document.getElementById('save-video'),
            urlError: document.getElementById('url-error'),
            searchInput: document.getElementById('search-input'),
            themeToggle: document.getElementById('theme-toggle'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            videoPlayer: document.getElementById('video-player'),
            playerTitle: document.getElementById('player-title'),
            playerIframe: document.getElementById('player-iframe'),
            playerComments: document.getElementById('player-comments'),
            closePlayer: document.getElementById('close-player'),
            playerVideoList: document.getElementById('player-video-list'),
            createFirstCategory: document.getElementById('create-first-category'),
            playlistModal: document.getElementById('playlist-modal'),
            playlistModalTitle: document.getElementById('playlist-modal-title'),
            closePlaylistModal: document.getElementById('close-playlist-modal'),
            playlistModalLoading: document.getElementById('playlist-modal-loading'),
            playlistModalError: document.getElementById('playlist-modal-error'),
            playlistModalErrorMsg: document.getElementById('playlist-modal-error-msg'),
            playlistModalOpenYt: document.getElementById('playlist-modal-open-yt'),
            playlistModalList: document.getElementById('playlist-modal-list'),
            selectionActions: document.getElementById('selection-actions'),
            selectionCount: document.getElementById('selection-count'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            clearSelectionBtn: document.getElementById('clear-selection-btn')
        };

        // Utilidades
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveToStorage() {
            try {
                const toSave = { ...appState, selectedVideoIds: [] };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            } catch (error) {
                console.error('Error saving to storage:', error);
            }
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    appState = { ...appState, ...data };
                    appState.selectedVideoIds = [];
                    if (!appState.expandedCategories || typeof appState.expandedCategories !== 'object') {
                        appState.expandedCategories = {};
                    }
                }
            } catch (error) {
                console.error('Error loading from storage:', error);
            }
        }

        function loadPlaylistCache() {
            try {
                const stored = localStorage.getItem(PLAYLIST_CACHE_KEY);
                if (stored) {
                    playlistCache = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Error loading playlist cache:', error);
            }
        }

        function savePlaylistCache() {
            try {
                localStorage.setItem(PLAYLIST_CACHE_KEY, JSON.stringify(playlistCache));
            } catch (error) {
                console.error('Error saving playlist cache:', error);
            }
        }

        function validateVideoUrl(url) {
            if (!url || typeof url !== 'string') return null;

            const playlistMatch = url.match(YOUTUBE_PLAYLIST_REGEX);
            if (playlistMatch && playlistMatch[1]) {
                return {
                    platform: 'youtube-playlist',
                    playlistId: playlistMatch[1]
                };
            }

            const youtubeMatch = url.match(YOUTUBE_REGEX);
            if (youtubeMatch && youtubeMatch[1]) {
                return {
                    platform: 'youtube',
                    videoId: youtubeMatch[1]
                };
            }

            const udemyMatch = url.match(UDEMY_REGEX);
            if (udemyMatch && udemyMatch[1]) {
                return {
                    platform: 'udemy',
                    videoId: udemyMatch[1]
                };
            }

            return null;
        }

        function getEmbedUrl(url, platform, videoId) {
            if (platform === 'youtube') {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            if (platform === 'udemy') {
                return url; // Udemy requiere autenticaci√≥n
            }
            return null;
        }

        function getThumbnailUrl(videoId, platform) {
            if (platform === 'youtube' && videoId) {
                return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            }
            return null;
        }

        async function fetchVideoTitle(url, platform) {
            try {
                if (platform === 'youtube') {
                    const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;
                    const response = await fetch(oembedUrl);
                    if (response.ok) {
                        const data = await response.json();
                        return data.title || 'Video de YouTube';
                    }
                }
            } catch (error) {
                console.error('Error fetching video title:', error);
            }
            
            if (platform === 'youtube') return 'Video de YouTube';
            if (platform === 'udemy') return 'Video de Udemy';
            return 'Video';
        }

        async function createVideoObject(url, comments = '') {
            const validation = validateVideoUrl(url);
            if (!validation) {
                throw new Error('URL de video no v√°lida');
            }

            const { platform, videoId, playlistId } = validation;
            const title = await fetchVideoTitle(url, platform);
            const thumbnail = getThumbnailUrl(videoId, platform);

            return {
                id: generateId(),
                url,
                platform: platform === 'youtube-playlist' ? 'youtube' : platform,
                videoId,
                playlistId,
                isPlaylist: platform === 'youtube-playlist',
                title,
                thumbnail,
                comments,
                createdAt: Date.now()
            };
        }

        async function fetchPlaylistItems(playlistId) {
            const rssUrl = `https://www.youtube.com/feeds/videos.xml?playlist_id=${encodeURIComponent(playlistId)}`;
            const corsProxy = 'https://api.allorigins.win/raw?url=';
            const res = await fetch(corsProxy + encodeURIComponent(rssUrl));
            if (!res.ok) {
                throw new Error(`No se pudo cargar la lista (${res.status}). La playlist debe ser p√∫blica.`);
            }
            const xml = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const entries = doc.getElementsByTagName('entry');
            const items = [];
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                let videoId = '';
                let title = 'Sin t√≠tulo';
                for (const el of entry.children) {
                    const local = (el.localName || el.tagName || '').toLowerCase();
                    if (local === 'videoid' || (el.tagName && el.tagName.endsWith('videoId'))) {
                        videoId = (el.textContent || '').trim();
                    }
                    if (local === 'title') {
                        title = (el.textContent || '').trim() || title;
                    }
                }
                if (!videoId && entry.getElementsByTagName('id').length) {
                    const idEl = entry.getElementsByTagName('id')[0];
                    const idVal = (idEl?.textContent || '').trim();
                    const m = idVal.match(/yt:video:(.{11})$/);
                    if (m) videoId = m[1];
                }
                if (!videoId) continue;
                items.push({
                    videoId,
                    title,
                    thumbnail: getThumbnailUrl(videoId, 'youtube')
                });
            }
            playlistCache[playlistId] = { items, fetchedAt: Date.now() };
            savePlaylistCache();
            return items;
        }

        function showPlaylistModalState(state) {
            const loading = elements.playlistModalLoading;
            const err = elements.playlistModalError;
            const list = elements.playlistModalList;
            if (!loading || !err || !list) return;
            loading.classList.add('hidden');
            err.classList.add('hidden');
            list.classList.add('hidden');
            if (state === 'loading') loading.classList.remove('hidden');
            else if (state === 'error') err.classList.remove('hidden');
            else if (state === 'list') list.classList.remove('hidden');
        }

        function showPlaylistModalError(msg, youtubeUrl) {
            showPlaylistModalState('error');
            if (elements.playlistModalErrorMsg) elements.playlistModalErrorMsg.textContent = msg || 'Error al cargar la lista';
            const link = elements.playlistModalOpenYt;
            if (link) {
                if (youtubeUrl) {
                    link.href = youtubeUrl;
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
            }
        }

        function renderPlaylistModalList(items) {
            const container = elements.playlistModalList;
            if (!container) return;
            container.innerHTML = '';
            (items || []).forEach((it) => {
                const card = document.createElement('div');
                card.className = 'bg-bg-tertiary rounded-lg overflow-hidden cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg group flex gap-3 p-2';
                card.onclick = () => {
                    closePlaylistModal();
                    playPlaylistItem(it.videoId, it.title, it.thumbnail);
                };
                const thumb = it.thumbnail
                    ? `<img src="${it.thumbnail}" alt="" class="w-24 h-[54px] object-cover rounded flex-shrink-0" onerror="this.style.display='none'">`
                    : '<div class="w-24 h-[54px] bg-bg-primary rounded flex-shrink-0 flex items-center justify-center text-text-muted text-2xl">üé¨</div>';
                card.innerHTML = `
                    ${thumb}
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <div class="text-sm font-medium text-text-primary line-clamp-2">${it.title}</div>
                    </div>
                    <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-accent text-lg">‚ñ∂</span>
                    </div>
                `;
                container.appendChild(card);
            });
            showPlaylistModalState('list');
        }

        async function openPlaylistModal(video) {
            if (!video?.isPlaylist || !video?.playlistId) return;
            if (!elements.playlistModal || !elements.playlistModalTitle) return;

            const playlistId = video.playlistId;
            const title = video.title || 'Lista de reproducci√≥n';
            const youtubeUrl = video.url || `https://www.youtube.com/playlist?list=${playlistId}`;

            elements.playlistModalTitle.textContent = title;
            elements.playlistModal.classList.remove('hidden');

            const cached = playlistCache[playlistId];
            if (cached?.items?.length) {
                updatePlaylistThumbnailIfMissing(video.id, cached.items);
                renderPlaylistModalList(cached.items);
                return;
            }

            showPlaylistModalState('loading');
            try {
                const items = await fetchPlaylistItems(playlistId);
                if (items.length === 0) {
                    showPlaylistModalError('Esta lista no tiene videos visibles.', youtubeUrl);
                    return;
                }
                updatePlaylistThumbnailIfMissing(video.id, items);
                renderPlaylistModalList(items);
            } catch (e) {
                const msg = (e && e.message) || 'Error al cargar los videos de la lista.';
                showPlaylistModalError(msg, youtubeUrl);
            }
        }

        function updatePlaylistThumbnailIfMissing(videoId, items) {
            const v = findVideoById(videoId);
            if (!v || !v.isPlaylist || v.thumbnail || !items?.length) return;
            v.thumbnail = items[0].thumbnail;
            saveToStorage();
            render();
        }

        function closePlaylistModal() {
            if (elements.playlistModal) {
                elements.playlistModal.classList.add('hidden');
            }
        }

        function playPlaylistItem(videoId, title, thumbnail) {
            const virtual = {
                platform: 'youtube',
                videoId,
                title: title || 'Video',
                thumbnail: thumbnail || getThumbnailUrl(videoId, 'youtube'),
                url: `https://www.youtube.com/watch?v=${videoId}`,
                _fromPlaylist: true
            };
            appState.selectedVideo = virtual;
            if (elements.playerTitle) elements.playerTitle.textContent = virtual.title;
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            if (elements.playerIframe) {
                elements.playerIframe.src = embedUrl;
                elements.playerIframe.style.display = '';
            }
            const flexMin = document.querySelector('#video-player .flex-1.min-h-0');
            if (flexMin && !flexMin.contains(elements.playerIframe)) {
                flexMin.innerHTML = '';
                flexMin.appendChild(elements.playerIframe);
            }
            if (elements.playerComments) {
                elements.playerComments.classList.add('hidden');
            }
            renderPlayerVideoList();
            if (elements.videoPlayer) elements.videoPlayer.classList.remove('hidden');
        }

        // Funciones de renderizado
        function renderCategories() {
            const container = elements.categoriesList;
            container.innerHTML = '';

            if (appState.categories.length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.boardView.classList.add('hidden');
                elements.listView.classList.add('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            if (appState.currentView === 'board') {
                elements.boardView.classList.remove('hidden');
                elements.listView.classList.add('hidden');
            } else {
                elements.boardView.classList.add('hidden');
                elements.listView.classList.remove('hidden');
            }

            appState.categories.forEach((category, idx) => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-bg-tertiary rounded-lg flex justify-between items-center gap-2 transition-all duration-200 hover:bg-border-primary border border-transparent border-dashed category-draggable';
                li.draggable = true;
                li.dataset.categoryId = category.id;
                li.dataset.categoryIndex = String(idx);
                li.innerHTML = `
                    <span class="cursor-grab active:cursor-grabbing text-text-muted shrink-0" title="Arrastrar para reordenar">‚ãÆ‚ãÆ</span>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-text-primary mb-1">${category.name}</div>
                        <div class="text-xs text-text-muted">${category.videos.length} videos</div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="event.stopPropagation(); editCategory('${category.id}')" class="bg-transparent border-none cursor-pointer text-base p-1 opacity-60 transition-opacity duration-200 hover:opacity-100" title="Editar">‚úèÔ∏è</button>
                        <button onclick="event.stopPropagation(); deleteCategory('${category.id}')" class="bg-transparent border-none cursor-pointer text-base p-1 opacity-60 transition-opacity duration-200 hover:opacity-100" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(li);
            });

            // Actualizar select de categor√≠as en el modal
            updateCategorySelect();
        }

        function updateCategorySelect() {
            const select = elements.videoCategory;
            select.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
            
            appState.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        function isCategoryExpanded(categoryId) {
            if (appState.expandedCategories.hasOwnProperty(categoryId)) {
                return !!appState.expandedCategories[categoryId];
            }
            return true;
        }

        function toggleCategoryExpanded(categoryId) {
            appState.expandedCategories[categoryId] = !isCategoryExpanded(categoryId);
            saveToStorage();
            render();
        }

        function toggleVideoSelection(videoId, e) {
            if (e) e.stopPropagation();
            const idx = appState.selectedVideoIds.indexOf(videoId);
            if (idx >= 0) {
                appState.selectedVideoIds.splice(idx, 1);
            } else {
                appState.selectedVideoIds.push(videoId);
            }
            updateSelectionUI();
            render();
        }

        function isVideoSelected(videoId) {
            return appState.selectedVideoIds.includes(videoId);
        }

        function clearSelection() {
            appState.selectedVideoIds = [];
            updateSelectionUI();
            render();
        }

        function deleteSelectedVideos() {
            if (!appState.selectedVideoIds.length) return;
            if (!confirm(`¬øEliminar ${appState.selectedVideoIds.length} video(s) seleccionado(s)?`)) return;
            appState.categories.forEach(cat => {
                cat.videos = cat.videos.filter(v => !appState.selectedVideoIds.includes(v.id));
            });
            appState.selectedVideoIds = [];
            saveToStorage();
            updateSelectionUI();
            render();
        }

        function updateSelectionUI() {
            const n = appState.selectedVideoIds.length;
            const bar = elements.selectionActions;
            const count = elements.selectionCount;
            const delBtn = elements.deleteSelectedBtn;
            if (!bar || !count || !delBtn) return;
            if (n > 0) {
                bar.classList.remove('hidden');
                count.textContent = n + ' seleccionado' + (n !== 1 ? 's' : '');
                delBtn.textContent = 'Eliminar seleccionados';
            } else {
                bar.classList.add('hidden');
            }
        }

        function renderBoardView() {
            const container = elements.boardView;
            container.innerHTML = '';

            const filteredCategories = getFilteredCategories();

            filteredCategories.forEach(category => {
                const column = document.createElement('div');
                column.className = 'bg-bg-secondary rounded-lg p-4 min-w-[280px] flex flex-col board-column';
                column.dataset.categoryId = category.id;
                column.dataset.dropCategory = category.id;
                column.innerHTML = `
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <h3 class="text-base font-semibold text-text-primary">${category.name}</h3>
                        <button type="button" onclick="addVideoToCategory('${category.id}')" class="px-2 py-1 rounded-lg text-xs font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+</button>
                    </div>
                    <div class="flex flex-col gap-3 board-videos board-videos-scroll min-h-0 overflow-y-auto max-h-[calc(2*320px+0.75rem)] pr-4" id="videos-${category.id}" data-drop-category="${category.id}">
                        ${category.videos.map((video, i) => renderVideoCard(video, false, category.id, i)).join('')}
                    </div>
                `;
                container.appendChild(column);
            });
        }

        function renderListView() {
            const container = elements.listView;
            container.innerHTML = '';

            const filteredCategories = getFilteredCategories();

            filteredCategories.forEach(category => {
                const expanded = isCategoryExpanded(category.id);
                const section = document.createElement('div');
                section.className = 'list-category-section border border-border-primary rounded-lg overflow-hidden bg-bg-secondary';
                section.dataset.categoryId = category.id;
                section.dataset.dropCategory = category.id;
                section.dataset.categoryIndex = String(appState.categories.findIndex(c => c.id === category.id));
                const chevron = expanded ? '‚ñº' : '‚ñ∂';
                section.innerHTML = `
                    <div class="list-category-header flex items-center justify-between gap-3 px-4 py-3 bg-bg-tertiary cursor-pointer hover:bg-border-primary transition-colors border-b border-border-primary" onclick="toggleCategoryExpanded('${category.id}')">
                        <div class="flex items-center gap-2">
                            <span class="text-text-muted text-sm">${chevron}</span>
                            <h3 class="text-base font-semibold text-text-primary">${category.name}</h3>
                            <span class="text-xs text-text-muted">(${category.videos.length})</span>
                        </div>
                        <button onclick="event.stopPropagation(); addVideoToCategory('${category.id}')" class="px-2 py-1 rounded-lg text-xs font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">+</button>
                    </div>
                    <div class="list-category-videos p-4 ${expanded ? '' : 'hidden'} grid grid-cols-1 md:grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-3" data-drop-category="${category.id}">
                        ${category.videos.map((video, i) => renderVideoCard({ ...video, categoryName: category.name }, true, category.id, i)).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function handleVideoCardClick(videoId) {
            const video = findVideoById(videoId);
            if (!video) return;
            if (video.isPlaylist) {
                openPlaylistModal(video);
            } else {
                playVideo(videoId);
            }
        }

        function getPlaylistCardThumbnail(video) {
            if (video.thumbnail) return video.thumbnail;
            if (video.isPlaylist && video.playlistId && playlistCache[video.playlistId]?.items?.[0]?.thumbnail) {
                return playlistCache[video.playlistId].items[0].thumbnail;
            }
            return null;
        }

        function renderVideoCard(video, showCategory = false, categoryId = '', videoIndex = -1) {
            const thumb = getPlaylistCardThumbnail(video);
            const thumbnailHtml = thumb
                ? `<img src="${thumb}" alt="${video.title}" class="absolute top-0 left-0 w-full h-full object-cover" onerror="this.style.display='none'">`
                : `<div class="absolute inset-0 flex items-center justify-center text-text-muted">
                     ${video.isPlaylist ? 'üìã' : 'üé¨'}
                   </div>`;

            const platformBg = video.platform === 'youtube' ? 'bg-red-500/10 text-red-500' : 'bg-black/10 text-text-primary';
            const checked = isVideoSelected(video.id) ? ' checked' : '';
            const dataAttrs = categoryId ? ` data-video-id="${video.id}" data-category-id="${categoryId}" data-video-index="${videoIndex}"` : '';
            const dragHandle = categoryId ? '<span class="video-drag-handle cursor-grab active:cursor-grabbing text-text-muted opacity-60 hover:opacity-100 shrink-0 self-center" title="Arrastrar">‚ãÆ‚ãÆ</span>' : '';

            return `
                <div class="video-card shrink-0 bg-bg-tertiary rounded-lg overflow-hidden cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg group border-2 border-transparent ${isVideoSelected(video.id) ? 'ring-2 ring-accent' : ''}"
                    onclick="handleVideoCardClick('${video.id}')" draggable="true"${dataAttrs}>
                    <div class="relative w-full pt-[56.25%] bg-bg-primary overflow-hidden">
                        ${thumbnailHtml}
                        <div class="absolute top-2 left-2 z-10" onclick="event.stopPropagation(); toggleVideoSelection('${video.id}', event)">
                            <input type="checkbox" class="video-checkbox w-4 h-4 rounded cursor-pointer" ${checked} onclick="event.stopPropagation(); toggleVideoSelection('${video.id}', event)">
                        </div>
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <button type="button" class="bg-accent text-white border-none px-4 py-2 rounded-md font-medium cursor-pointer">‚ñ∂ Reproducir</button>
                        </div>
                    </div>
                    <div class="p-3 flex gap-2 items-start">
                        ${dragHandle}
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium text-text-primary mb-2 line-clamp-2">${video.title}</h4>
                            <div class="flex justify-between items-center flex-wrap gap-1">
                                <span class="text-xs px-2 py-1 rounded font-medium ${platformBg}">
                                    ${video.platform === 'youtube' ? 'YouTube' : 'Udemy'}
                                    ${video.isPlaylist ? ' Playlist' : ''}
                                </span>
                                <div class="flex gap-2">
                                    <button type="button" onclick="event.stopPropagation(); editVideo('${video.id}')" class="bg-transparent border-none cursor-pointer text-sm opacity-60 transition-opacity duration-200 hover:opacity-100" title="Editar">‚úèÔ∏è</button>
                                    <button type="button" onclick="event.stopPropagation(); deleteVideo('${video.id}')" class="bg-transparent border-none cursor-pointer text-sm opacity-60 transition-opacity duration-200 hover:opacity-100" title="Eliminar">üóëÔ∏è</button>
                                </div>
                            </div>
                            ${showCategory ? `<div class="text-xs text-text-muted mt-1">${video.categoryName}</div>` : ''}
                            ${video.comments ? `<div class="text-xs text-text-muted mt-2 italic">${video.comments}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getFilteredCategories() {
            if (!appState.searchQuery) return appState.categories;
            
            return appState.categories.filter(category => {
                const categoryMatch = category.name.toLowerCase().includes(appState.searchQuery.toLowerCase());
                const videoMatch = category.videos.some(video => 
                    video.title.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
                    (video.comments && video.comments.toLowerCase().includes(appState.searchQuery.toLowerCase()))
                );
                return categoryMatch || videoMatch;
            }).map(category => ({
                ...category,
                videos: category.videos.filter(video =>
                    video.title.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
                    (video.comments && video.comments.toLowerCase().includes(appState.searchQuery.toLowerCase()))
                )
            }));
        }

        function getFilteredVideos(videos) {
            if (!appState.searchQuery) return videos;
            
            return videos.filter(video =>
                video.title.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
                (video.comments && video.comments.toLowerCase().includes(appState.searchQuery.toLowerCase())) ||
                video.categoryName.toLowerCase().includes(appState.searchQuery.toLowerCase())
            );
        }

        // Funciones de la aplicaci√≥n
        function addCategory() {
            if (!elements.categoryInput) return;
            const name = elements.categoryInput.value.trim();
            if (!name) return;

            const newCategory = {
                id: generateId(),
                name: name,
                videos: []
            };

            appState.categories.push(newCategory);
            elements.categoryInput.value = '';
            saveToStorage();
            render();
        }

        function deleteCategory(categoryId) {
            if (!confirm('¬øEliminar esta categor√≠a y todos sus videos?')) return;
            
            appState.categories = appState.categories.filter(cat => cat.id !== categoryId);
            saveToStorage();
            render();
        }

        function editCategory(categoryId) {
            const category = appState.categories.find(cat => cat.id === categoryId);
            if (!category) return;

            const newName = prompt('Nuevo nombre de la categor√≠a:', category.name);
            if (newName && newName.trim()) {
                category.name = newName.trim();
                saveToStorage();
                render();
            }
        }

        function showAddVideoModal(categoryId) {
            if (categoryId === undefined) categoryId = null;
            if (elements.addVideoModal) {
                elements.addVideoModal.classList.remove('hidden');
            }
            if (categoryId && elements.videoCategory) {
                elements.videoCategory.value = categoryId;
            }
            if (elements.videoUrl) {
                elements.videoUrl.focus();
            }
        }

        function hideAddVideoModal() {
            if (elements.addVideoModal) {
                elements.addVideoModal.classList.add('hidden');
            }
            if (elements.addVideoForm) {
                elements.addVideoForm.reset();
            }
            if (elements.urlError) {
                elements.urlError.classList.add('hidden');
            }
        }

        async function addVideo() {
            if (!elements.videoUrl || !elements.videoCategory || !elements.videoComments) return;
            
            const url = elements.videoUrl.value.trim();
            const categoryId = elements.videoCategory.value;
            const comments = elements.videoComments.value.trim();

            if (!url) {
                showError('Por favor ingresa una URL');
                return;
            }

            if (!validateVideoUrl(url)) {
                showError('URL no v√°lida. Debe ser de YouTube o Udemy.');
                return;
            }

            if (!categoryId) {
                showError('Por favor selecciona una categor√≠a');
                return;
            }

            try {
                if (elements.saveVideo) {
                    elements.saveVideo.textContent = 'Agregando...';
                    elements.saveVideo.disabled = true;
                }

                const videoData = await createVideoObject(url, comments);
                const category = appState.categories.find(cat => cat.id === categoryId);

                if (category) {
                    if (videoData.isPlaylist && videoData.playlistId) {
                        try {
                            const items = await fetchPlaylistItems(videoData.playlistId);
                            if (items.length) videoData.thumbnail = items[0].thumbnail;
                        } catch (e) { /* dejar thumbnail null */ }
                    }
                    category.videos.push(videoData);
                    saveToStorage();
                    render();
                    hideAddVideoModal();
                }
            } catch (error) {
                showError((error && error.message) || 'Error al agregar el video');
            } finally {
                if (elements.saveVideo) {
                    elements.saveVideo.textContent = 'Agregar';
                    elements.saveVideo.disabled = false;
                }
            }
        }

        function showError(message) {
            if (elements.urlError) {
                elements.urlError.textContent = message;
                elements.urlError.classList.remove('hidden');
            }
        }

        function deleteVideo(videoId) {
            if (!confirm('¬øEliminar este video?')) return;

            appState.categories.forEach(category => {
                category.videos = category.videos.filter(video => video.id !== videoId);
            });
            appState.selectedVideoIds = appState.selectedVideoIds.filter(id => id !== videoId);

            saveToStorage();
            render();
        }

        function editVideo(videoId) {
            const video = findVideoById(videoId);
            if (!video) return;

            const newComments = prompt('Comentarios:', video.comments || '');
            if (newComments !== null) {
                video.comments = newComments.trim();
                saveToStorage();
                render();
            }
        }

        function findVideoById(videoId) {
            for (const category of appState.categories) {
                const video = category.videos.find(v => v.id === videoId);
                if (video) return video;
            }
            return null;
        }

        function playVideo(videoId) {
            const video = findVideoById(videoId);
            if (!video) return;

            appState.selectedVideo = video;
            elements.playerTitle.textContent = video.title;
            
            const embedUrl = getEmbedUrl(video.url, video.platform, video.videoId);
            if (embedUrl && video.platform === 'youtube') {
                elements.playerIframe.src = embedUrl;
            } else {
                elements.playerIframe.src = '';
                // Para Udemy, mostrar enlace
                elements.playerIframe.style.display = 'none';
                const playerVideo = document.querySelector('.flex-1.min-h-0');
                if (playerVideo) {
                    playerVideo.innerHTML = `
                        <div class="flex items-center justify-center h-full bg-black text-white text-center p-5">
                            <div>
                                <p class="mb-4">Los videos de Udemy requieren autenticaci√≥n</p>
                                <a href="${video.url}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white hover:bg-accent-hover">Abrir en Udemy</a>
                            </div>
                        </div>
                    `;
                }
            }

            if (video.comments) {
                elements.playerComments.textContent = video.comments;
                elements.playerComments.classList.remove('hidden');
            } else {
                elements.playerComments.classList.add('hidden');
            }

            renderPlayerVideoList();
            elements.videoPlayer.classList.remove('hidden');
        }

        function renderPlayerVideoList() {
            const container = elements.playerVideoList;
            container.innerHTML = '';

            const allVideos = appState.categories.flatMap(cat => 
                cat.videos.map(video => ({ ...video, categoryName: cat.name }))
            );

            allVideos.forEach(video => {
                const item = document.createElement('div');
                const isActive = video.id === appState.selectedVideo?.id;
                item.className = `p-3 rounded-lg mb-2 cursor-pointer transition-all duration-200 ${isActive ? 'bg-accent text-white' : 'bg-white/5 hover:bg-white/10'}`;
                item.onclick = () => playVideo(video.id);
                item.innerHTML = `
                    <div class="text-sm font-medium mb-1">${video.title}</div>
                    <div class="text-xs opacity-70">${video.categoryName}</div>
                `;
                container.appendChild(item);
            });
        }

        function closeVideoPlayer() {
            elements.videoPlayer.classList.add('hidden');
            elements.playerIframe.src = '';
            appState.selectedVideo = null;
        }

        function getThemeRoot() {
            return document.getElementById('video-organizer-root');
        }

        function applyTheme() {
            const root = getThemeRoot();
            if (root) root.setAttribute('data-theme', appState.currentTheme);
            if (elements.themeToggle) {
                elements.themeToggle.textContent = appState.currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                elements.themeToggle.title = appState.currentTheme === 'dark' ? 'Modo claro' : 'Modo oscuro';
            }
        }

        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveToStorage();
        }

        function setView(view) {
            appState.currentView = view;
            // Actualizar clases Tailwind para botones activos
            if (view === 'board') {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
            } else {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
            }
            saveToStorage();
            render();
        }

        function handleSearch() {
            if (elements.searchInput) {
                appState.searchQuery = elements.searchInput.value.trim();
                render();
            }
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(appState, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'video-organizer-backup.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error al exportar datos: ' + error.message);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.categories && Array.isArray(data.categories)) {
                            if (confirm('¬øImportar estos datos? Se reemplazar√°n los datos actuales.')) {
                                appState = { ...appState, ...data };
                                saveToStorage();
                                render();
                                alert('Datos importados correctamente');
                            }
                        } else {
                            alert('Formato de archivo inv√°lido');
                        }
                    } catch (error) {
                        alert('Error al importar: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function render() {
            renderCategories();
            if (appState.currentView === 'board') {
                renderBoardView();
            } else {
                renderListView();
            }
            updateSelectionUI();
        }

        function setupDragDrop() {
            let draggedCategoryId = null;
            let draggedVideoId = null;
            let draggedFromCategoryId = null;

            document.addEventListener('dragstart', (e) => {
                const li = e.target.closest('.category-draggable');
                if (li) {
                    draggedCategoryId = li.dataset.categoryId;
                    e.dataTransfer.setData('text/plain', 'category:' + draggedCategoryId);
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('application/json', JSON.stringify({ type: 'category', id: draggedCategoryId }));
                    return;
                }
                const card = e.target.closest('.video-card');
                if (card && card.dataset.videoId) {
                    if (e.target.closest('button, input, .video-checkbox')) return;
                    draggedVideoId = card.dataset.videoId;
                    draggedFromCategoryId = card.dataset.categoryId;
                    e.dataTransfer.setData('text/plain', 'video:' + draggedVideoId);
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('application/json', JSON.stringify({ type: 'video', videoId: draggedVideoId, categoryId: draggedFromCategoryId }));
                }
            });

            document.addEventListener('dragover', (e) => {
                if (e.target.closest('.category-draggable') && draggedCategoryId) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                }
                if ((e.target.closest('.video-card') || e.target.closest('[data-drop-category]')) && draggedVideoId) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                }
            });

            document.addEventListener('drop', (e) => {
                const catLi = e.target.closest('.category-draggable');
                if (catLi && draggedCategoryId) {
                    e.preventDefault();
                    const targetId = catLi.dataset.categoryId;
                    if (targetId === draggedCategoryId) {
                        draggedCategoryId = null;
                        return;
                    }
                    const fromIdx = appState.categories.findIndex(c => c.id === draggedCategoryId);
                    const toIdx = appState.categories.findIndex(c => c.id === targetId);
                    if (fromIdx < 0 || toIdx < 0) { draggedCategoryId = null; return; }
                    const [removed] = appState.categories.splice(fromIdx, 1);
                    appState.categories.splice(toIdx, 0, removed);
                    saveToStorage();
                    render();
                    draggedCategoryId = null;
                    return;
                }

                const videoCard = e.target.closest('.video-card');
                const dropZone = e.target.closest('[data-drop-category]');
                if ((videoCard || dropZone) && draggedVideoId) {
                    e.preventDefault();
                    if (videoCard && videoCard.dataset.videoId === draggedVideoId) {
                        draggedVideoId = null;
                        draggedFromCategoryId = null;
                        return;
                    }
                    let targetCategoryId, insertIndex;
                    if (videoCard && videoCard.dataset.categoryId) {
                        targetCategoryId = videoCard.dataset.categoryId;
                        insertIndex = parseInt(videoCard.dataset.videoIndex, 10);
                        if (isNaN(insertIndex)) insertIndex = 0;
                    } else if (dropZone) {
                        targetCategoryId = dropZone.dataset.dropCategory;
                        insertIndex = -1;
                    }
                    if (!targetCategoryId) { draggedVideoId = null; draggedFromCategoryId = null; return; }

                    let video = null;
                    let fromCat = null;
                    for (const c of appState.categories) {
                        const v = c.videos.find(x => x.id === draggedVideoId);
                        if (v) { video = v; fromCat = c; break; }
                    }
                    if (!video || !fromCat) { draggedVideoId = null; draggedFromCategoryId = null; return; }

                    if (fromCat.id === targetCategoryId && insertIndex >= 0) {
                        const fromIdx = fromCat.videos.findIndex(x => x.id === draggedVideoId);
                        if (fromIdx < 0) { draggedVideoId = null; return; }
                        fromCat.videos.splice(fromIdx, 1);
                        let insertAt = insertIndex;
                        if (fromIdx < insertIndex) insertAt--;
                        fromCat.videos.splice(Math.max(0, insertAt), 0, video);
                    } else {
                        fromCat.videos = fromCat.videos.filter(x => x.id !== draggedVideoId);
                        const toCat = appState.categories.find(c => c.id === targetCategoryId);
                        if (!toCat) { draggedVideoId = null; return; }
                        if (insertIndex < 0) toCat.videos.push(video);
                        else toCat.videos.splice(Math.min(insertIndex, toCat.videos.length), 0, video);
                    }
                    saveToStorage();
                    render();
                    draggedVideoId = null;
                    draggedFromCategoryId = null;
                }
            });

            document.addEventListener('dragend', () => {
                draggedCategoryId = null;
                draggedVideoId = null;
                draggedFromCategoryId = null;
            });
        }

        // Funciones globales para eventos onclick
        window.addVideoToCategory = function(categoryId) { showAddVideoModal(categoryId); };
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.deleteVideo = deleteVideo;
        window.editVideo = editVideo;
        window.playVideo = playVideo;
        window.handleVideoCardClick = handleVideoCardClick;
        window.toggleCategoryExpanded = toggleCategoryExpanded;
        window.toggleVideoSelection = toggleVideoSelection;

        // Funci√≥n para registrar event listeners
        function setupEventListeners() {
            // Event listeners
            if (elements.boardViewBtn) {
                elements.boardViewBtn.addEventListener('click', () => setView('board'));
            }
            if (elements.listViewBtn) {
                elements.listViewBtn.addEventListener('click', () => setView('list'));
            }
            if (elements.addCategoryBtn) {
                elements.addCategoryBtn.addEventListener('click', addCategory);
            }
            if (elements.categoryInput) {
                elements.categoryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addCategory();
                });
            }
            if (elements.addVideoBtn) {
                elements.addVideoBtn.addEventListener('click', () => showAddVideoModal());
            }
            if (elements.closeVideoModal) {
                elements.closeVideoModal.addEventListener('click', hideAddVideoModal);
            }
            if (elements.cancelVideo) {
                elements.cancelVideo.addEventListener('click', hideAddVideoModal);
            }
            if (elements.addVideoForm) {
                elements.addVideoForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    addVideo();
                });
            }
            if (elements.searchInput) {
                elements.searchInput.addEventListener('input', handleSearch);
            }
            if (elements.themeToggle) {
                elements.themeToggle.addEventListener('click', toggleTheme);
            }
            if (elements.exportBtn) {
                elements.exportBtn.addEventListener('click', exportData);
            }
            if (elements.importBtn) {
                elements.importBtn.addEventListener('click', importData);
            }
            if (elements.deleteSelectedBtn) {
                elements.deleteSelectedBtn.addEventListener('click', deleteSelectedVideos);
            }
            if (elements.clearSelectionBtn) {
                elements.clearSelectionBtn.addEventListener('click', clearSelection);
            }
            if (elements.closePlayer) {
                elements.closePlayer.addEventListener('click', closeVideoPlayer);
            }
            if (elements.createFirstCategory) {
                elements.createFirstCategory.addEventListener('click', () => {
                    if (elements.categoryInput) {
                        elements.categoryInput.focus();
                    }
                });
            }
            if (elements.closePlaylistModal) {
                elements.closePlaylistModal.addEventListener('click', closePlaylistModal);
            }
            if (elements.playlistModal) {
                elements.playlistModal.addEventListener('click', (e) => {
                    if (e.target === elements.playlistModal) closePlaylistModal();
                });
            }

            // Cerrar modales con Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (elements.addVideoModal && !elements.addVideoModal.classList.contains('hidden')) {
                        hideAddVideoModal();
                    }
                    if (elements.playlistModal && !elements.playlistModal.classList.contains('hidden')) {
                        closePlaylistModal();
                    }
                    if (elements.videoPlayer && !elements.videoPlayer.classList.contains('hidden')) {
                        closeVideoPlayer();
                    }
                }
            });

            // Cerrar modales clickeando fuera
            if (elements.addVideoModal) {
                elements.addVideoModal.addEventListener('click', (e) => {
                    if (e.target === elements.addVideoModal) {
                        hideAddVideoModal();
                    }
                });
            }

            if (elements.videoPlayer) {
                elements.videoPlayer.addEventListener('click', (e) => {
                    if (e.target === elements.videoPlayer) {
                        closeVideoPlayer();
                    }
                });
            }
        }

        // Inicializaci√≥n
        function init() {
            // Re-obtener elementos del DOM por si acaso
            elements.boardViewBtn = document.getElementById('board-view-btn');
            elements.listViewBtn = document.getElementById('list-view-btn');
            elements.addVideoBtn = document.getElementById('add-video-btn');
            elements.addCategoryBtn = document.getElementById('add-category-btn');
            elements.categoryInput = document.getElementById('category-input');
            elements.searchInput = document.getElementById('search-input');
            elements.themeToggle = document.getElementById('theme-toggle');
            elements.addVideoModal = document.getElementById('add-video-modal');
            elements.closeVideoModal = document.getElementById('close-video-modal');
            elements.cancelVideo = document.getElementById('cancel-video');
            elements.addVideoForm = document.getElementById('add-video-form');
            elements.videoUrl = document.getElementById('video-url');
            elements.videoCategory = document.getElementById('video-category');
            elements.videoComments = document.getElementById('video-comments');
            elements.saveVideo = document.getElementById('save-video');
            elements.urlError = document.getElementById('url-error');
            elements.exportBtn = document.getElementById('export-btn');
            elements.importBtn = document.getElementById('import-btn');
            elements.videoPlayer = document.getElementById('video-player');
            elements.closePlayer = document.getElementById('close-player');
            elements.playerTitle = document.getElementById('player-title');
            elements.playerIframe = document.getElementById('player-iframe');
            elements.playerComments = document.getElementById('player-comments');
            elements.playerVideoList = document.getElementById('player-video-list');
            elements.createFirstCategory = document.getElementById('create-first-category');
            elements.boardView = document.getElementById('board-view');
            elements.listView = document.getElementById('list-view');
            elements.emptyState = document.getElementById('empty-state');
            elements.categoriesList = document.getElementById('categories-list');
            elements.selectionActions = document.getElementById('selection-actions');
            elements.selectionCount = document.getElementById('selection-count');
            elements.deleteSelectedBtn = document.getElementById('delete-selected-btn');
            elements.clearSelectionBtn = document.getElementById('clear-selection-btn');

            loadFromStorage();
            loadPlaylistCache();
            applyTheme();
            // Inicializar clases de botones de vista
            if (appState.currentView === 'board') {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
            } else {
                if (elements.boardViewBtn) {
                    elements.boardViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-transparent text-text-muted hover:text-text-primary';
                }
                if (elements.listViewBtn) {
                    elements.listViewBtn.className = 'px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium cursor-pointer transition-all duration-200 bg-accent text-white shadow-sm';
                }
            }
            
            setupEventListeners();
            setupDragDrop();
            render();
        }

        // Iniciar la aplicaci√≥n cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // Si el DOM ya est√° listo, ejecutar inmediatamente
            setTimeout(init, 0);
        }
    </script>
    </div>

    <style is:global>
        .board-videos-scroll {
            scrollbar-gutter: stable;
        }
        .board-videos-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .board-videos-scroll::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
            margin-block: 4px;
        }
        .board-videos-scroll::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 4px;
        }
        .board-videos-scroll::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
        .board-videos-scroll {
            scrollbar-width: thin;
            scrollbar-color: #2a2a2a #1a1a1a;
        }
        #video-organizer-root[data-theme="light"] .board-videos-scroll::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        #video-organizer-root[data-theme="light"] .board-videos-scroll::-webkit-scrollbar-thumb {
            background: #d1d5db;
        }
        #video-organizer-root[data-theme="light"] .board-videos-scroll::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
        #video-organizer-root[data-theme="light"] .board-videos-scroll {
            scrollbar-color: #d1d5db #e5e7eb;
        }

        /* Modo claro: overrides de colores */
        #video-organizer-root[data-theme="light"] {
            background-color: #f5f5f5;
        }
        #video-organizer-root[data-theme="light"] .bg-bg-primary { background-color: #f5f5f5 !important; }
        #video-organizer-root[data-theme="light"] .bg-bg-secondary { background-color: #ffffff !important; }
        #video-organizer-root[data-theme="light"] .bg-bg-tertiary { background-color: #f3f4f6 !important; }
        #video-organizer-root[data-theme="light"] .border-border-primary { border-color: #e5e7eb !important; }
        #video-organizer-root[data-theme="light"] .text-text-primary { color: #111827 !important; }
        #video-organizer-root[data-theme="light"] .text-text-secondary { color: #374151 !important; }
        #video-organizer-root[data-theme="light"] .text-text-muted { color: #6b7280 !important; }
        #video-organizer-root[data-theme="light"] .hover\:bg-border-primary:hover { background-color: #e5e7eb !important; }
        #video-organizer-root[data-theme="light"] .hover\:bg-bg-tertiary:hover { background-color: #e5e7eb !important; }
        #video-organizer-root[data-theme="light"] .hover\:text-text-primary:hover { color: #111827 !important; }
        #video-organizer-root[data-theme="light"] .focus\:border-accent:focus { border-color: #6366f1 !important; }
        #video-organizer-root[data-theme="light"] .bg-black\/90 { background-color: rgba(17, 24, 39, 0.95) !important; }
        #video-organizer-root[data-theme="light"] .bg-black\/70 { background-color: rgba(0, 0, 0, 0.5) !important; }
        #video-organizer-root[data-theme="light"] .bg-black\/95 { background-color: rgba(0, 0, 0, 0.85) !important; }
        #video-organizer-root[data-theme="light"] .bg-black\/50 { background-color: rgba(0, 0, 0, 0.4) !important; }
    </style>
</BaseTailwind>
