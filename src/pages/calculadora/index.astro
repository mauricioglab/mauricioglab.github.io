---
// Calculadora de costos para impresi√≥n 3D - Aplicaci√≥n Astro
import BaseTailwind from '@layouts/BaseTailwind.astro';
import { Image } from 'astro:assets';
import calculadoraLogo from '@assets/images/calculadora-logo.jpg';

export const prerender = true;

const title = "Creatopia Calc";
---

<BaseTailwind 
    title={title}
    description="Calculadora de costos para impresi√≥n 3D"
    lang="es"
    layoutType="tool"
    showPromptModal={true}
>
    <div class="container">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: #333;
        }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input[type="number"]:focus {
            border-color: #3b82f6;
            outline: none;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-outline {
            background-color: transparent;
            color: #6b7280;
            border: 2px solid #6b7280;
        }
        
        .btn-outline:hover {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .result-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: normal;
        }
        
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .alert-warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .alert-info {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .alert-success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .collapsible {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .collapsible-header {
            padding: 15px;
            cursor: pointer;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px 4px 0 0;
        }
        
        .collapsible-header:hover {
            background: #f3f4f6;
        }
        
        .collapsible-content {
            display: none !important;
        }
        
        .collapsible-content.show {
            display: block !important;
        }
        
        .hidden {
            display: none !important;
        }
        
        .price-final {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid;
        }
        
        .price-persona {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }
        
        .price-competencia {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }
        
        .price-sin-competencia {
            background: #fed7aa;
            color: #9a3412;
            border-color: #f97316;
        }
        
        .test-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .text-center {
            text-align: center;
        }
        
        .header {
            text-align: center;
            margin: 30px 0;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .header img,
        .header .logo-image {
            height: 50px;
            width: auto;
            object-fit: contain;
        }
        
        .header h1 {
            margin: 0;
            line-height: 1.2;
        }
        
        .header p {
            margin: 0;
        }
        
        small {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        @media (max-width: 480px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
            
            .result-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
                border-radius: 0;
            }
            
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <Image src={calculadoraLogo} alt="Creatopia Calc" class="logo-image rounded-xl shadow-md" />
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">{title}</h1>
            </div>
            <p class="text-slate-500 text-sm md:text-base mt-2">Calculadora de costos para impresi√≥n 3D</p>
        </div>

        <!-- Formulario Principal -->
        <section class="space-y-2">
            <!-- Fila principal: Horas, Minutos, Gramos -->
            <div class="flex gap-3">
                <div class="form-group flex-1">
                    <label for="horasImpresion">Horas</label>
                    <input type="number" id="horasImpresion" step="0.01" placeholder="0">
                </div>
                <div class="form-group flex-1">
                    <label for="minutosImpresion">Minutos</label>
                    <input type="number" id="minutosImpresion" value="0" placeholder="0">
                </div>
                <div class="form-group flex-1">
                    <label for="gramosFilamento">Gramos</label>
                    <input type="number" id="gramosFilamento" step="0.1" placeholder="0">
                </div>
            </div>
            <!-- Fila: Costo, Cantidad, Precio ML -->
            <div class="flex gap-3">
                <div class="form-group flex-1">
                    <label for="costoFilamento">$/kg</label>
                    <input type="number" id="costoFilamento" step="0.01" placeholder="20000">
                </div>
                <div class="form-group flex-1">
                    <label for="cantidad">Unidades</label>
                    <input type="number" id="cantidad" value="1" min="1" placeholder="1">
                </div>
                <div class="form-group flex-1">
                    <label for="precioMercadoLibre">Precio Meli</label>
                    <input type="number" id="precioMercadoLibre" value="0" step="0.01" placeholder="0">
                </div>
            </div>
        </section>

        <!-- Bot√≥n Calcular -->
        <section class="text-center py-4">
            <button onclick="window.calcular()" class="btn-primary btn-full">üßÆ Calcular</button>
        </section>

        <!-- Botones de Acci√≥n -->
        <section class="pt-2">
            <div class="flex gap-2">
                <button onclick="window.toggleHistorial()" class="btn-secondary flex-1 text-sm">üìã Historial</button>
                <button onclick="window.nombrarEntrada()" class="btn-secondary flex-1 text-sm">üíæ Guardar</button>
                <button onclick="window.toggleCostosFijos()" class="btn-secondary flex-1 text-sm">‚öôÔ∏è Config</button>
            </div>
            <button onclick="window.toggleTestInterno()" class="btn-secondary hidden" id="testButton">üß™ Test ML</button>
        </section>

        <!-- Secci√≥n de Historial -->
        <section id="historial" class="hidden mt-6">
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                <h2 class="text-lg font-semibold text-slate-800 mb-3 pb-2 border-b border-slate-200">üìã Historial de C√°lculos</h2>
                <div id="historialLista" class="mb-3"></div>
                <button onclick="window.limpiarHistorial()" class="btn-outline btn-full text-sm">Limpiar Historial</button>
            </div>
        </section>

        <!-- Secci√≥n de Configuraci√≥n -->
        <section id="costosFijos" class="hidden mt-6">
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                <h2 class="text-lg font-semibold text-slate-800 mb-4 pb-2 border-b border-slate-200">‚öôÔ∏è Configuraci√≥n</h2>
                
                <div class="flex gap-2 mb-4">
                    <button onclick="window.cargarReferencias()" class="btn-secondary flex-1 text-xs">Predeterminados</button>
                    <button onclick="window.resetear()" class="btn-outline flex-1 text-xs">Borrar</button>
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="window.exportarJSON()" class="btn-secondary flex-1 text-xs">üì§ Exportar</button>
                    <button onclick="window.importarJSON()" class="btn-secondary flex-1 text-xs">üì• Importar</button>
                </div>

                <h3 class="text-sm font-semibold text-slate-600 mb-2 flex items-center gap-2">üí∞ Costos Fijos</h3>
                <div class="calculator-grid">
                    <div class="form-group">
                        <label for="precioKwh">kWh ($/kWh):</label>
                        <input type="number" id="precioKwh" placeholder="234">
                    </div>
                    <div class="form-group">
                        <label for="consumoW">Consumo (W):</label>
                        <input type="number" id="consumoW" placeholder="120">
                    </div>
                    <div class="form-group">
                        <label for="desgasteHoras">Vida √∫til (h):</label>
                        <input type="number" id="desgasteHoras" placeholder="15000">
                    </div>
                    <div class="form-group">
                        <label for="valorImpresora">Valor imp. ($):</label>
                        <input type="number" id="valorImpresora" placeholder="1363990">
                    </div>
                    <div class="form-group">
                        <label for="margenError">% Error:</label>
                        <input type="number" id="margenError" value="30" placeholder="30">
                    </div>
                    <div class="form-group">
                        <label for="comisionML">Comisi√≥n ML (%):</label>
                        <input type="number" id="comisionML" value="30" step="1" placeholder="30">
                    </div>
                </div>

                <h3 class="text-sm font-semibold text-slate-600 mb-2 mt-5 flex items-center gap-2">üîß Insumos</h3>
                <div class="calculator-grid">
                    <div class="form-group">
                        <label for="insumos">Insumos ($):</label>
                        <input type="number" id="insumos" value="0" step="0.01" placeholder="0">
                    </div>
                </div>

                <h3 class="text-sm font-semibold text-slate-600 mb-2 mt-5 flex items-center gap-2">üîó Extras Llaveros</h3>
                <div class="calculator-grid">
                    <div class="form-group">
                        <label for="precioCadena">Precio cadena:</label>
                        <input type="number" id="precioCadena" value="0" step="0.01" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="cantidadCadenas">Cantidad:</label>
                        <input type="number" id="cantidadCadenas" value="0" min="0" placeholder="0">
                    </div>
                </div>

                <h3 class="text-sm font-semibold text-slate-600 mb-2 mt-5 flex items-center gap-2">üí∏ Precios</h3>
                <div class="calculator-grid">
                    <div class="form-group">
                        <label for="descuentoVentaPersona">Descuento (%):</label>
                        <input type="number" id="descuentoVentaPersona" step="1" value="5" min="0" max="100" placeholder="5">
                        <small class="text-slate-500 text-xs">% menos que ML Competencia</small>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t border-slate-200">
                    <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                        <input type="checkbox" id="debugMode" onchange="window.toggleDebugMode()" class="rounded">
                        üîß Modo Debug
                    </label>
                    <small class="text-slate-400 text-xs">Herramientas de desarrollo</small>
                </div>
            </div>
        </section>

        <!-- Secci√≥n de Resultados -->
        <section id="resultados" class="hidden mt-6">
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <h2 class="text-lg font-semibold text-blue-800 mb-3 pb-2 border-b border-blue-200">üìä Resultados</h2>
                <div id="detalleResultados"></div>
            </div>
        </section>
    </div>

    <script>
        // Declarar tipos para propiedades din√°micas en window
        declare global {
            interface Window {
                REF: { precioKg: number; precioKwh: number; consumoW: number; desgasteHoras: number; valorImpresora: number; margenError: number; comisionML: number };
                entradaActual: any;
                formatoArgentino: (numero: number) => string;
                formatoPrecioFinal: (numero: number) => string;
                generarAlertaGeneral: (precioVentaPersona: number, precioMLCompetencia: number, precioMLSinCompetencia: number) => string;
                cargarDatos: () => void;
                cargarHistorial: () => void;
                cargarDebugMode: () => void;
                toggleDebugMode: () => void;
                toggleHistorial: () => void;
                toggleCostosFijos: () => void;
                calcular: () => void;
                showTab: (tabId: string) => void;
                setDecision: (type: string, value: boolean) => void;
                toggleCollapsible: (id: string, eventElement?: HTMLElement) => void;
                guardarDatos: () => void;
                cargarReferencias: () => void;
                resetear: () => void;
                exportarJSON: () => void;
                importarJSON: () => void;
                mostrarHistorial: () => void;
                limpiarHistorial: () => void;
                toggleTestInterno: () => void;
                nombrarEntrada: () => void;
                cargarDesdeHistorial: (id: string) => void;
                eliminarDelHistorial: (id: string) => void;
            }
        }
        
        // Valores de referencia para configuraci√≥n r√°pida
        window.REF = {
            precioKg: 20000,
            precioKwh: 234,
            consumoW: 120,
            desgasteHoras: 15000,
            valorImpresora: 1363990,
            margenError: 30,
            comisionML: 30
        };

        // Variable para entrada actual
        window.entradaActual = null;

        // Funci√≥n para formatear n√∫meros en estilo argentino
        window.formatoArgentino = function(numero: number) {
            return numero.toLocaleString('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        // Funci√≥n para redondear precios a centenas
        window.formatoPrecioFinal = function(numero: number) {
            const redondeado = Math.round(numero / 100) * 100;
            return redondeado.toLocaleString('es-AR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };

        // Funci√≥n para generar alertas generales
        window.generarAlertaGeneral = function(precioVentaPersona: number, precioMLCompetencia: number, precioMLSinCompetencia: number) {
            const precioMercadoLibre = parseFloat((document.getElementById('precioMercadoLibre') as HTMLInputElement)?.value || '0') || 0;
            
            if (precioMercadoLibre === 0) {
                return '';
            }
            
            if (precioMercadoLibre < precioMLCompetencia) {
                return `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ADVERTENCIA</strong><br>
                        El precio de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}) es menor que tu ML Competencia ($${window.formatoPrecioFinal(precioMLCompetencia)}). Quiz√°s no conviene ir por MercadoLibre.
                    </div>
                `;
            } else if (precioMercadoLibre >= precioMLCompetencia && precioMercadoLibre <= precioMLSinCompetencia) {
                const diferenciaPorcentaje = ((precioMercadoLibre - precioMLCompetencia) / precioMLCompetencia) * 100;
                return `
                    <div class="alert alert-info">
                        <strong>üí° RECOMENDACI√ìN</strong><br>
                        El precio de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}) es ${diferenciaPorcentaje.toFixed(1)}% mayor que tu ML Competencia. Debes ajustar el precio por encima del valor ML Competencia ($${window.formatoPrecioFinal(precioMLCompetencia)}) pero no exceder el valor de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}).
                    </div>
                `;
            } else {
                return `
                    <div class="alert alert-success">
                        <strong>üí° OPORTUNIDAD</strong><br>
                        El precio de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}) es mayor que tu ML Sin Competencia ($${window.formatoPrecioFinal(precioMLSinCompetencia)}). Debes ajustar el precio por encima del valor ML Sin Competencia ($${window.formatoPrecioFinal(precioMLSinCompetencia)}).
                    </div>
                `;
            }
        };

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            window.cargarDatos();
            window.cargarHistorial();
            window.cargarDebugMode();
        });

        // Gesti√≥n del modo debug
        window.cargarDebugMode = function() {
            const debugMode = sessionStorage.getItem('debugMode') === 'true';
            const debugCheckbox = document.getElementById('debugMode') as HTMLInputElement;
            if (debugCheckbox) {
                debugCheckbox.checked = debugMode;
                window.toggleDebugMode();
            } else {
                const testButton = document.getElementById('testButton');
                if (testButton) {
                    testButton.classList.add('hidden');
                }
            }
        };

        window.toggleDebugMode = function() {
            const debugCheckbox = document.getElementById('debugMode') as HTMLInputElement;
            const testButton = document.getElementById('testButton');
            
            if (debugCheckbox) {
                const isDebugMode = debugCheckbox.checked;
                sessionStorage.setItem('debugMode', String(isDebugMode));
                
                if (testButton) {
                    if (isDebugMode) {
                        testButton.classList.remove('hidden');
                    } else {
                        testButton.classList.add('hidden');
                    }
                }
            }
        };

        // Funciones de historial
        window.toggleHistorial = function() {
            const historial = document.getElementById('historial');
            if (!historial) return;
            if (historial.classList.contains('hidden')) {
                historial.classList.remove('hidden');
                window.mostrarHistorial();
            } else {
                historial.classList.add('hidden');
            }
        };

        window.toggleCostosFijos = function() {
            const costosFijos = document.getElementById('costosFijos');
            if (!costosFijos) return;
            if (costosFijos.classList.contains('hidden')) {
                costosFijos.classList.remove('hidden');
            } else {
                costosFijos.classList.add('hidden');
            }
        };

        // Funci√≥n principal de c√°lculo
        window.calcular = async function() {
            // Obtener valores de entrada
            const precioKg = parseFloat((document.getElementById('costoFilamento') as HTMLInputElement)?.value || '0') || 0;
            const precioKwh = parseFloat((document.getElementById('precioKwh') as HTMLInputElement)?.value || '0') || 0;
            const consumoW = parseFloat((document.getElementById('consumoW') as HTMLInputElement)?.value || '0') || 0;
            const desgasteHoras = parseFloat((document.getElementById('desgasteHoras') as HTMLInputElement)?.value || '0') || 0;
            const valorImpresora = parseFloat((document.getElementById('valorImpresora') as HTMLInputElement)?.value || '0') || 0;
            const margenErrorPct = (parseFloat((document.getElementById('margenError') as HTMLInputElement)?.value || '0') || 0) / 100;
            const comisionMLPct = (parseFloat((document.getElementById('comisionML') as HTMLInputElement)?.value || '30') || 30) / 100;
            
            const horas = parseFloat((document.getElementById('horasImpresion') as HTMLInputElement)?.value || '0') || 0;
            const minutos = parseFloat((document.getElementById('minutosImpresion') as HTMLInputElement)?.value || '0') || 0;
            const tiempoTotalHoras = horas + (minutos / 60);
            
            const gramos = parseFloat((document.getElementById('gramosFilamento') as HTMLInputElement)?.value || '0') || 0;
            const insumos = parseFloat((document.getElementById('insumos') as HTMLInputElement)?.value || '0') || 0;
            let descuentoVentaPersona = parseFloat((document.getElementById('descuentoVentaPersona') as HTMLInputElement)?.value || '5') || 5;
            
            const cantidad = parseFloat((document.getElementById('cantidad') as HTMLInputElement)?.value || '1') || 1;
            const precioCadena = parseFloat((document.getElementById('precioCadena') as HTMLInputElement)?.value || '0') || 0;
            const cantidadCadenas = parseFloat((document.getElementById('cantidadCadenas') as HTMLInputElement)?.value || '0') || 0;

            // Validaci√≥n
            if (precioKg === 0 || gramos === 0) {
                await window.showAlertModal({
                    title: '‚ö†Ô∏è Datos faltantes',
                    message: 'Ingresa precio filamento y gramos',
                    confirmText: 'OK'
                });
                return;
            }

            // C√°lculos
            const costoMaterial = (precioKg / 1000) * gramos;
            const costoElectricidad = ((consumoW / 1000) * precioKwh) * tiempoTotalHoras;
            const valorDepreciable = valorImpresora * 0.7;
            const costoDesgaste = desgasteHoras > 0 ? (valorDepreciable / desgasteHoras) * tiempoTotalHoras : 0;
            const costoBase = costoMaterial + costoElectricidad + costoDesgaste;
            const margenError = costoBase * margenErrorPct;
            const costoConMargen = costoBase + margenError;
            
            // Calcular precios ML
            const gananciaCompetencia = parseFloat(localStorage.getItem('gananciaCompetencia') || '175') || 175;
            const gananciaSinCompetencia = parseFloat(localStorage.getItem('gananciaSinCompetencia') || '700') || 700;
            
            const multiplicadorCompetencia = 1 + (gananciaCompetencia / 100);
            const costoConGananciaCompetencia = costoConMargen * multiplicadorCompetencia;
            const totalCobrarCompetencia = costoConGananciaCompetencia + insumos;
            const precioMLCompetencia = totalCobrarCompetencia / (1 - comisionMLPct);
            
            const multiplicadorSinCompetencia = 1 + (gananciaSinCompetencia / 100);
            const costoConGananciaSinCompetencia = costoConMargen * multiplicadorSinCompetencia;
            const totalCobrarSinCompetencia = costoConGananciaSinCompetencia + insumos;
            const precioMLSinCompetencia = totalCobrarSinCompetencia / (1 - comisionMLPct);
            
            // Calcular venta a persona
            const totalCobrar = precioMLCompetencia * (1 - descuentoVentaPersona / 100);
            
            // Redondear precios finales
            const totalCobrarRedondeado = Math.round(totalCobrar / 100) * 100;
            const precioMLCompetenciaRedondeado = Math.round(precioMLCompetencia / 100) * 100;
            const precioMLSinCompetenciaRedondeado = Math.round(precioMLSinCompetencia / 100) * 100;
            
            // Calcular ganancias reales
            const costoTotal = costoConMargen + insumos;
            const gananciaReal = totalCobrarRedondeado - costoTotal;
            const ingresoMLCompetencia = precioMLCompetenciaRedondeado * (1 - comisionMLPct);
            const ingresoMLSinCompetencia = precioMLSinCompetenciaRedondeado * (1 - comisionMLPct);
            const gananciaMLCompetencia = ingresoMLCompetencia - costoTotal;
            const gananciaMLSinCompetencia = ingresoMLSinCompetencia - costoTotal;
            
            // C√°lculos finales con cantidad y cadenas
            const costoCadenas = precioCadena * cantidadCadenas;
            const totalDirecto = (totalCobrarRedondeado * cantidad) + costoCadenas;
            const totalMLCompetenciaFinal = (precioMLCompetenciaRedondeado * cantidad) + costoCadenas;
            const totalMLSinCompetenciaFinal = (precioMLSinCompetenciaRedondeado * cantidad) + costoCadenas;

            // Generar HTML de resultados con √°rbol de decisi√≥n
            let html = `
                <!-- √Årbol de decisi√≥n -->
                <div class="decision-tree mb-4">
                    <!-- Pregunta 1: ¬øMercadoLibre? -->
                    <div class="flex items-center justify-between p-3 bg-slate-100 rounded-lg mb-2">
                        <span class="text-sm font-medium text-slate-700">¬øVender en MercadoLibre?</span>
                        <div class="flex gap-2">
                            <button id="btn-no-ml" onclick="window.setDecision('ml', false)" class="decision-btn active px-3 py-1 text-xs rounded-full bg-green-600 text-white">No</button>
                            <button id="btn-si-ml" onclick="window.setDecision('ml', true)" class="decision-btn px-3 py-1 text-xs rounded-full bg-slate-300 text-slate-600">S√≠</button>
                        </div>
                    </div>
                    
                    <!-- Pregunta 2: ¬øHay competencia? (solo si ML=s√≠) -->
                    <div id="competencia-question" class="hidden flex items-center justify-between p-3 bg-slate-100 rounded-lg mb-2">
                        <span class="text-sm font-medium text-slate-700">¬øHay competencia en Meli?</span>
                        <div class="flex gap-2">
                            <button id="btn-si-comp" onclick="window.setDecision('comp', true)" class="decision-btn active px-3 py-1 text-xs rounded-full bg-orange-500 text-white">S√≠</button>
                            <button id="btn-no-comp" onclick="window.setDecision('comp', false)" class="decision-btn px-3 py-1 text-xs rounded-full bg-slate-300 text-slate-600">No</button>
                        </div>
                    </div>
                </div>
                
                <!-- Precio resultante -->
                <div id="price-result-direct" class="price-result">
                    <div class="text-center p-6 bg-green-50 border-2 border-green-200 rounded-xl">
                        <div class="text-sm text-green-600 font-medium mb-1">üíµ Venta Directa</div>
                        <div class="text-4xl font-bold text-green-700">$${window.formatoPrecioFinal(totalCobrarRedondeado)}</div>
                        <div class="text-xs text-green-500 mt-2">Costo: $${Math.round(costoTotal).toLocaleString('es-AR')} | Ganancia: $${Math.round(gananciaReal).toLocaleString('es-AR')}</div>
                    </div>
                </div>
                
                <div id="price-result-ml-comp" class="price-result hidden">
                    <div class="text-center p-6 bg-orange-50 border-2 border-orange-200 rounded-xl">
                        <div class="text-sm text-orange-600 font-medium mb-1">üõí MercadoLibre (con competencia)</div>
                        <div class="text-4xl font-bold text-orange-700">$${window.formatoPrecioFinal(precioMLCompetenciaRedondeado)}</div>
                        <div class="text-xs text-orange-500 mt-2">Costo: $${Math.round(costoTotal).toLocaleString('es-AR')} | Ganancia: $${Math.round(gananciaMLCompetencia).toLocaleString('es-AR')}</div>
                    </div>
                </div>
                
                <div id="price-result-ml-nocomp" class="price-result hidden">
                    <div class="text-center p-6 bg-purple-50 border-2 border-purple-200 rounded-xl">
                        <div class="text-sm text-purple-600 font-medium mb-1">‚≠ê MercadoLibre (sin competencia)</div>
                        <div class="text-4xl font-bold text-purple-700">$${window.formatoPrecioFinal(precioMLSinCompetenciaRedondeado)}</div>
                        <div class="text-xs text-purple-500 mt-2">Costo: $${Math.round(costoTotal).toLocaleString('es-AR')} | Ganancia: $${Math.round(gananciaMLSinCompetencia).toLocaleString('es-AR')}</div>
                        <div class="mt-3 p-2 bg-purple-100 rounded-lg text-xs text-purple-700">
                            ‚ö†Ô∏è Este es el <strong>precio m√°ximo sugerido</strong>. Pod√©s publicar a este valor o menos seg√∫n tu estrategia.
                        </div>
                    </div>
                </div>
                
                ${window.generarAlertaGeneral(totalCobrarRedondeado, precioMLCompetenciaRedondeado, precioMLSinCompetenciaRedondeado)}
                
                <!-- Desglose de costos -->
                <div class="mt-4 border border-slate-200 rounded-lg overflow-hidden">
                    <button class="collapsible-header w-full flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 text-left" onclick="window.toggleCollapsible('detalle-costos', this)">
                        <span class="text-sm font-medium text-slate-600">üìä Ver Desglose de Costos</span>
                        <span class="text-slate-400">‚ñº</span>
                    </button>
                    <div class="collapsible-content p-3 text-sm text-slate-600 border-t border-slate-200" id="detalle-costos">
                        <div class="flex justify-between py-1"><span>Material (${gramos}g)</span><span>$${window.formatoArgentino(costoMaterial)}</span></div>
                        <div class="flex justify-between py-1"><span>Electricidad (${tiempoTotalHoras.toFixed(2)}h)</span><span>$${window.formatoArgentino(costoElectricidad)}</span></div>
                        <div class="flex justify-between py-1"><span>Desgaste</span><span>$${window.formatoArgentino(costoDesgaste)}</span></div>
                        <div class="flex justify-between py-2 mt-2 border-t border-slate-200 font-semibold text-slate-700">
                            <span>üí∞ Costo Base</span><span>$${window.formatoArgentino(costoBase)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Margen de error -->
                <div class="mt-2 border border-slate-200 rounded-lg overflow-hidden">
                    <button class="collapsible-header w-full flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 text-left" onclick="window.toggleCollapsible('detalle-margen', this)">
                        <span class="text-sm font-medium text-slate-600">‚ö†Ô∏è Ver Margen de Error</span>
                        <span class="text-slate-400">‚ñº</span>
                    </button>
                    <div class="collapsible-content p-3 text-sm text-slate-600 border-t border-slate-200" id="detalle-margen">
                        <div class="flex justify-between py-1"><span>Margen de Error ${(margenErrorPct*100).toFixed(0)}%</span><span>$${window.formatoArgentino(margenError)}</span></div>
                        <div class="flex justify-between py-2 mt-2 border-t border-slate-200 font-semibold text-slate-700">
                            <span>Con Margen de Error</span><span>$${window.formatoArgentino(costoConMargen)}</span>
                        </div>
                    </div>
                </div>
            `;

            // Agregar totales por cantidad si es necesario
            if (cantidad > 1 || costoCadenas > 0) {
                html += `
                <div style="margin-top: 30px;">
                    <h3>üì¶ Totales por Cantidad</h3>
                    <div class="test-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>üíµ Venta a Persona</th>
                                    <th>üõí ML Competencia</th>
                                    <th>‚≠ê ML Sin Competencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>üìä Cantidad</td>
                                    <td>${cantidad} unidades</td>
                                    <td>${cantidad} unidades</td>
                                    <td>${cantidad} unidades</td>
                                </tr>`;
                
                if (costoCadenas > 0) {
                    html += `
                                <tr>
                                    <td>üîó Cadenas</td>
                                    <td>$${Math.round(costoCadenas).toLocaleString('es-AR')}</td>
                                    <td>$${Math.round(costoCadenas).toLocaleString('es-AR')}</td>
                                    <td>$${Math.round(costoCadenas).toLocaleString('es-AR')}</td>
                                </tr>`;
                }
                
                html += `
                                <tr style="font-weight: bold;">
                                    <td>üíµ TOTAL FINAL</td>
                                    <td>$${window.formatoPrecioFinal(totalDirecto)}</td>
                                    <td>$${window.formatoPrecioFinal(totalMLCompetenciaFinal)}</td>
                                    <td>$${window.formatoPrecioFinal(totalMLSinCompetenciaFinal)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            // Mostrar resultados
            const detalleResultados = document.getElementById('detalleResultados');
            const resultados = document.getElementById('resultados');
            if (detalleResultados) detalleResultados.innerHTML = html;
            if (resultados) resultados.classList.remove('hidden');
            window.guardarDatos();
        };

        // Estado de decisiones
        let decisionState = { ml: false, comp: true };
        
        // Funci√≥n para manejar el √°rbol de decisi√≥n
        window.setDecision = function(type: string, value: boolean) {
            if (type === 'ml') {
                decisionState.ml = value;
                // Actualizar botones ML
                const btnNoMl = document.getElementById('btn-no-ml');
                const btnSiMl = document.getElementById('btn-si-ml');
                const compQuestion = document.getElementById('competencia-question');
                
                if (btnNoMl && btnSiMl) {
                    if (value) {
                        btnSiMl.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-blue-600 text-white';
                        btnNoMl.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-slate-300 text-slate-600';
                    } else {
                        btnNoMl.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-green-600 text-white';
                        btnSiMl.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-slate-300 text-slate-600';
                    }
                }
                
                // Mostrar/ocultar pregunta de competencia
                if (compQuestion) {
                    compQuestion.classList.toggle('hidden', !value);
                }
            } else if (type === 'comp') {
                decisionState.comp = value;
                // Actualizar botones competencia
                const btnSiComp = document.getElementById('btn-si-comp');
                const btnNoComp = document.getElementById('btn-no-comp');
                
                if (btnSiComp && btnNoComp) {
                    if (value) {
                        btnSiComp.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-orange-500 text-white';
                        btnNoComp.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-slate-300 text-slate-600';
                    } else {
                        btnNoComp.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-purple-600 text-white';
                        btnSiComp.className = 'decision-btn px-3 py-1 text-xs rounded-full bg-slate-300 text-slate-600';
                    }
                }
            }
            
            // Actualizar precio visible
            const priceDirect = document.getElementById('price-result-direct');
            const priceMLComp = document.getElementById('price-result-ml-comp');
            const priceMLNoComp = document.getElementById('price-result-ml-nocomp');
            
            // Ocultar todos
            [priceDirect, priceMLComp, priceMLNoComp].forEach(el => el?.classList.add('hidden'));
            
            // Mostrar el correcto
            if (!decisionState.ml) {
                priceDirect?.classList.remove('hidden');
            } else if (decisionState.comp) {
                priceMLComp?.classList.remove('hidden');
            } else {
                priceMLNoComp?.classList.remove('hidden');
            }
        };

        // Funci√≥n para mostrar pesta√±as
        window.showTab = function(tabId: string, buttonElement?: HTMLElement) {
            // Ocultar todas las pesta√±as
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            buttons.forEach(function(button) {
                button.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activar el bot√≥n correspondiente
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Buscar el bot√≥n por su onclick
                buttons.forEach(function(button) {
                    const onclick = button.getAttribute('onclick');
                    if (onclick && onclick.includes(tabId)) {
                        button.classList.add('active');
                    }
                });
            }
        };

        // Funci√≥n para toggle de collapsibles
        window.toggleCollapsible = function(id: string, eventElement?: HTMLElement) {
            const content = document.getElementById(id);
            if (!content) return;
            
            let header = null;
            if (eventElement) {
                header = eventElement.closest ? eventElement.closest('.collapsible-header') : eventElement.parentElement;
            } else {
                header = content.previousElementSibling;
            }
            
            if (!header) return;
            const icon = header.querySelector('span:last-child');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                if (icon) icon.textContent = '‚ñº';
            } else {
                content.classList.add('show');
                if (icon) icon.textContent = '‚ñ≤';
            }
        };

        // Funciones de persistencia de datos
        window.guardarDatos = function() {
            const getValue = (id: string) => (document.getElementById(id) as HTMLInputElement)?.value || '';
            const datos = {
                costoFilamento: getValue('costoFilamento'),
                precioKwh: getValue('precioKwh'),
                consumoW: getValue('consumoW'),
                desgasteHoras: getValue('desgasteHoras'),
                valorImpresora: getValue('valorImpresora'),
                margenError: getValue('margenError'),
                comisionML: getValue('comisionML'),
                horasImpresion: getValue('horasImpresion'),
                minutosImpresion: getValue('minutosImpresion'),
                gramosFilamento: getValue('gramosFilamento'),
                insumos: getValue('insumos'),
                descuentoVentaPersona: getValue('descuentoVentaPersona'),
                cantidad: getValue('cantidad'),
                precioMercadoLibre: getValue('precioMercadoLibre'),
                precioCadena: getValue('precioCadena'),
                cantidadCadenas: getValue('cantidadCadenas'),
            };
            sessionStorage.setItem('calc3D', JSON.stringify(datos));
        };

        window.cargarDatos = function() {
            const datos = sessionStorage.getItem('calc3D');
            if (datos) {
                const obj = JSON.parse(datos);
                Object.keys(obj).forEach(function(key) {
                    const elemento = document.getElementById(key) as HTMLInputElement;
                    if (elemento && obj[key]) {
                        if (key === 'descuentoVentaPersona') {
                            let valor = parseFloat(obj[key]);
                            if (isNaN(valor) || valor < 0) valor = 5;
                            if (valor > 50) valor = 50;
                            elemento.value = String(valor);
                        } else {
                            elemento.value = obj[key];
                        }
                    }
                });
            } else {
                window.cargarReferencias();
                const descInput = document.getElementById('descuentoVentaPersona') as HTMLInputElement;
                if (descInput) descInput.value = '5';
            }
        };

        window.cargarReferencias = async function() {
            const setValue = (id: string, value: number) => {
                const el = document.getElementById(id) as HTMLInputElement;
                if (el) el.value = String(value);
            };
            setValue('costoFilamento', window.REF.precioKg);
            setValue('precioKwh', window.REF.precioKwh);
            setValue('consumoW', window.REF.consumoW);
            setValue('desgasteHoras', window.REF.desgasteHoras);
            setValue('valorImpresora', window.REF.valorImpresora);
            setValue('margenError', window.REF.margenError);
            setValue('comisionML', window.REF.comisionML);
            window.guardarDatos();
            await window.showAlertModal({
                title: '‚úÖ Referencias cargadas',
                message: 'PLA: $20k/kg | kWh: $234\nConsumo: 120W | Vida √∫til: 15.000h\nImpresora: $1.363.990 | Comisi√≥n ML: 30%',
                confirmText: 'OK'
            });
        };

        window.resetear = async function() {
            const confirmed = await window.showConfirmModal({
                title: 'üóëÔ∏è Resetear',
                message: '¬øBorrar todos los datos?',
                confirmText: 'S√≠, borrar',
                cancelText: 'Cancelar'
            });
            if (confirmed) {
                sessionStorage.removeItem('calc3D');
                localStorage.removeItem('historial3D');
                location.reload();
            }
        };

        window.exportarJSON = function() {
            const datos = sessionStorage.getItem('calc3D');
            const historial = localStorage.getItem('historial3D');
            const exportData = {
                configuracion: datos ? JSON.parse(datos) : {},
                historial: historial ? JSON.parse(historial) : [],
                fecha: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'creatopia-calc-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.importarJSON = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e: any) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e: any) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        const confirmed = await window.showConfirmModal({
                            title: 'üì• Importar datos',
                            message: '¬øImportar estos datos? Se reemplazar√°n los datos actuales.',
                            confirmText: 'Importar',
                            cancelText: 'Cancelar'
                        });
                        
                        if (confirmed) {
                            // Importar configuraci√≥n
                            if (data.configuracion) {
                                sessionStorage.setItem('calc3D', JSON.stringify(data.configuracion));
                                window.cargarDatos();
                            }
                            
                            // Importar historial
                            if (data.historial && Array.isArray(data.historial)) {
                                localStorage.setItem('historial3D', JSON.stringify(data.historial));
                                window.mostrarHistorial();
                            }
                            
                            await window.showAlertModal({
                                title: '‚úÖ √âxito',
                                message: 'Datos importados correctamente',
                                confirmText: 'OK'
                            });
                        }
                    } catch (error: any) {
                        await window.showAlertModal({
                            title: '‚ùå Error',
                            message: 'Error al importar: ' + error.message,
                            confirmText: 'OK'
                        });
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        // Funciones de historial (simplificadas)
        window.cargarHistorial = function() {
            if (!localStorage.getItem('historial3D')) {
                localStorage.setItem('historial3D', '[]');
            }
        };

        window.mostrarHistorial = function() {
            const historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
            const lista = document.getElementById('historialLista');
            if (!lista) return;
            
            if (historial.length === 0) {
                lista.innerHTML = '<p>No hay c√°lculos guardados</p>';
                return;
            }
            
            lista.innerHTML = historial.map(function(item: any) {
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 15px; margin: 10px 0;">
                        <strong>${item.nombre || 'C√°lculo sin nombre'}</strong><br>
                        <small>${new Date(item.fecha).toLocaleString('es-AR')}</small><br>
                        <small>${item.datos?.entrada?.pieza?.gramosFilamento || 0}g - ${item.datos?.entrada?.pieza?.horasImpresion || 0}:${(item.datos?.entrada?.pieza?.minutosImpresion || 0).toString().padStart(2,'0')}</small>
                        <div style="margin-top: 10px;">
                            <button onclick="window.cargarDesdeHistorial('${item.id}')" class="btn-secondary" style="margin-right: 10px;">Cargar</button>
                            <button onclick="window.eliminarDelHistorial('${item.id}')" class="btn-outline">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.limpiarHistorial = async function() {
            const confirmed = await window.showConfirmModal({
                title: 'üóëÔ∏è Limpiar historial',
                message: '¬øEliminar TODO el historial?',
                confirmText: 'S√≠, eliminar',
                cancelText: 'Cancelar'
            });
            if (confirmed) {
                localStorage.setItem('historial3D', '[]');
                window.mostrarHistorial();
            }
        };

        // Funciones de test (simplificadas)
        window.toggleTestInterno = async function() {
            await window.showAlertModal({
                title: '‚ÑπÔ∏è Informaci√≥n',
                message: 'Funci√≥n de tests en desarrollo para la versi√≥n Astro',
                confirmText: 'OK'
            });
        };

        window.nombrarEntrada = async function() {
            const nombre = await window.showPromptModal({
                title: 'üìù Nombrar c√°lculo',
                inputType: 'text',
                placeholder: 'Nombre para este c√°lculo',
                confirmText: 'Guardar',
                cancelText: 'Cancelar'
            });
            if (nombre && nombre.trim()) {
                // Obtener valores actuales del formulario
                const getValue = (id: string) => parseFloat((document.getElementById(id) as HTMLInputElement)?.value || '0') || 0;
                
                const entrada = {
                    costosFijos: {
                        precioKg: getValue('costoFilamento'),
                        precioKwh: getValue('precioKwh'),
                        consumoW: getValue('consumoW'),
                        desgasteHoras: getValue('desgasteHoras'),
                        valorImpresora: getValue('valorImpresora'),
                        margenError: getValue('margenError'),
                        comisionML: getValue('comisionML'),
                    },
                    pieza: {
                        horasImpresion: getValue('horasImpresion'),
                        minutosImpresion: getValue('minutosImpresion'),
                        gramosFilamento: getValue('gramosFilamento'),
                    },
                    produccion: {
                        cantidad: getValue('cantidad') || 1,
                    },
                    extras: {
                        insumos: getValue('insumos'),
                        precioCadena: getValue('precioCadena'),
                        cantidadCadenas: getValue('cantidadCadenas'),
                    },
                    descuentoVentaPersona: getValue('descuentoVentaPersona'),
                };
                
                // Crear entrada de historial
                const historialItem = {
                    id: 'calc_' + Date.now(),
                    nombre: nombre.trim(),
                    fecha: new Date().toISOString(),
                    datos: { entrada }
                };
                
                // Guardar en historial
                const historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
                historial.unshift(historialItem); // Agregar al inicio
                localStorage.setItem('historial3D', JSON.stringify(historial));
                
                await window.showAlertModal({
                    title: '‚úÖ Guardado',
                    message: 'C√°lculo guardado como: ' + nombre.trim(),
                    confirmText: 'OK'
                });
                
                // Actualizar vista del historial si est√° visible
                window.mostrarHistorial();
            }
        };

        // Funciones de historial completas
        window.cargarDesdeHistorial = async function(id: string) {
            const historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
            const item = historial.find((h: any) => h.id === id);
            
            if (!item) {
                await window.showAlertModal({
                    title: '‚ùå Error',
                    message: 'No se encontr√≥ el c√°lculo en el historial',
                    confirmText: 'OK'
                });
                return;
            }
            
            const entrada = item.datos.entrada;
            const setValue = (id: string, value: any) => {
                const el = document.getElementById(id) as HTMLInputElement;
                if (el) el.value = String(value || '');
            };
            
            // Cargar costos fijos
            if (entrada.costosFijos) {
                setValue('costoFilamento', entrada.costosFijos.precioKg);
                setValue('precioKwh', entrada.costosFijos.precioKwh);
                setValue('consumoW', entrada.costosFijos.consumoW);
                setValue('desgasteHoras', entrada.costosFijos.desgasteHoras);
                setValue('valorImpresora', entrada.costosFijos.valorImpresora);
                setValue('margenError', entrada.costosFijos.margenError);
                setValue('comisionML', entrada.costosFijos.comisionML);
            }
            
            // Cargar datos de pieza
            if (entrada.pieza) {
                setValue('horasImpresion', entrada.pieza.horasImpresion);
                setValue('minutosImpresion', entrada.pieza.minutosImpresion);
                setValue('gramosFilamento', entrada.pieza.gramosFilamento);
            }
            
            // Cargar datos de producci√≥n
            if (entrada.produccion) {
                setValue('cantidad', entrada.produccion.cantidad || 1);
            }
            
            // Cargar extras
            if (entrada.extras) {
                setValue('insumos', entrada.extras.insumos || 0);
                setValue('precioCadena', entrada.extras.precioCadena || 0);
                setValue('cantidadCadenas', entrada.extras.cantidadCadenas || 0);
            }
            
            // Cargar descuento si existe
            if (entrada.descuentoVentaPersona !== undefined) {
                setValue('descuentoVentaPersona', entrada.descuentoVentaPersona || 5);
            }
            
            window.guardarDatos();
            await window.showAlertModal({
                title: '‚úÖ Cargado',
                message: 'Datos cargados del historial',
                confirmText: 'OK'
            });
            const historialEl = document.getElementById('historial');
            if (historialEl && !historialEl.classList.contains('hidden')) {
                window.toggleHistorial();
            }
            window.calcular();
        };

        window.eliminarDelHistorial = async function(id: string) {
            const confirmed = await window.showConfirmModal({
                title: 'üóëÔ∏è Eliminar',
                message: '¬øEliminar este c√°lculo del historial?',
                confirmText: 'Eliminar',
                cancelText: 'Cancelar'
            });
            if (!confirmed) return;
            
            let historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
            historial = historial.filter((h: any) => h.id !== id);
            localStorage.setItem('historial3D', JSON.stringify(historial));
            window.mostrarHistorial();
        };
    </script>
    </div>
</BaseTailwind>