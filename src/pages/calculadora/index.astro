---
// Calculadora de costos para impresi√≥n 3D - Aplicaci√≥n Astro
import BaseTailwind from '../../layouts/BaseTailwind.astro';
import logoImage from './logo.jpg';

export const prerender = true;

const title = "Creatopia Calc";
const baseUrl = import.meta.env.BASE_URL;
---

<BaseTailwind 
    title={title}
    description="Calculadora de costos para impresi√≥n 3D"
    lang="es"
>
    <div class="container">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: #333;
        }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input[type="number"]:focus {
            border-color: #3b82f6;
            outline: none;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-outline {
            background-color: transparent;
            color: #6b7280;
            border: 2px solid #6b7280;
        }
        
        .btn-outline:hover {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .result-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: normal;
        }
        
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .alert-warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .alert-info {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .alert-success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .collapsible {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .collapsible-header {
            padding: 15px;
            cursor: pointer;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px 4px 0 0;
        }
        
        .collapsible-header:hover {
            background: #f3f4f6;
        }
        
        .collapsible-content {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: none;
        }
        
        .collapsible-content.show {
            display: block;
        }
        
        .hidden {
            display: none !important;
        }
        
        .price-final {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid;
        }
        
        .price-persona {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }
        
        .price-competencia {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }
        
        .price-sin-competencia {
            background: #fed7aa;
            color: #9a3412;
            border-color: #f97316;
        }
        
        .test-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .text-center {
            text-align: center;
        }
        
        .header {
            text-align: center;
            margin: 30px 0;
        }
        
        .header img {
            height: 60px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        small {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
            
            .result-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
                border-radius: 0;
            }
            
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
        <!-- Header -->
        <div class="header">
            <img src={logoImage.src} alt="Creatopia Calc">
            <h1>{title}</h1>
            <p>Calculadora de costos para impresi√≥n 3D</p>
        </div>

        <!-- Formulario Principal -->
        <section>
            <h2>Datos de Impresi√≥n</h2>
            <div class="calculator-grid">
                <div class="form-group">
                    <label for="horasImpresion">Horas:</label>
                    <input type="number" id="horasImpresion" step="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="minutosImpresion">Minutos:</label>
                    <input type="number" id="minutosImpresion" value="0" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="gramosFilamento">Gramos:</label>
                    <input type="number" id="gramosFilamento" step="0.1" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="costoFilamento">Costo ($/kg):</label>
                    <input type="number" id="costoFilamento" step="0.01" placeholder="20000">
                </div>
                <div class="form-group">
                    <label for="cantidad">Cantidad (camas):</label>
                    <input type="number" id="cantidad" value="1" min="1" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="precioMercadoLibre">Precio ML ($) - Opcional:</label>
                    <input type="number" id="precioMercadoLibre" value="0" step="0.01" placeholder="0">
                </div>
            </div>
        </section>

        <!-- Bot√≥n Calcular -->
        <section class="text-center">
            <button onclick="window.calcular()" class="btn-primary btn-full">üßÆ Calcular</button>
        </section>

        <!-- Botones de Acci√≥n -->
        <section>
            <div class="calculator-grid">
                <button onclick="window.toggleHistorial()" class="btn-secondary">üìã Historial</button>
                <button onclick="window.nombrarEntrada()" class="btn-secondary">‚úèÔ∏è Nombrar</button>
                <button onclick="window.toggleTestInterno()" class="btn-secondary hidden" id="testButton">üß™ Test ML</button>
                <button onclick="window.toggleCostosFijos()" class="btn-secondary">‚öôÔ∏è Configuraci√≥n</button>
            </div>
        </section>

        <!-- Secci√≥n de Historial -->
        <section id="historial" class="hidden">
            <h2>üìã Historial de C√°lculos</h2>
            <div id="historialLista"></div>
            <button onclick="window.limpiarHistorial()" class="btn-outline btn-full">Limpiar Historial</button>
        </section>

        <!-- Secci√≥n de Configuraci√≥n -->
        <section id="costosFijos" class="hidden">
            <h2>‚öôÔ∏è Configuraci√≥n</h2>
            
            <div style="margin-bottom: 30px;">
                <div class="calculator-grid">
                    <button onclick="window.cargarReferencias()" class="btn-secondary">Valores Predeterminados</button>
                    <button onclick="window.resetear()" class="btn-outline">Borrar Todo</button>
                    <button onclick="window.exportarJSON()" class="btn-secondary">Exportar JSON</button>
                </div>
            </div>

            <h3>üí∞ Costos Fijos</h3>
            <div class="calculator-grid">
                <div class="form-group">
                    <label for="precioKwh">kWh ($/kWh):</label>
                    <input type="number" id="precioKwh" placeholder="234">
                </div>
                <div class="form-group">
                    <label for="consumoW">Consumo (W):</label>
                    <input type="number" id="consumoW" placeholder="120">
                </div>
                <div class="form-group">
                    <label for="desgasteHoras">Vida √∫til (h):</label>
                    <input type="number" id="desgasteHoras" placeholder="15000">
                </div>
                <div class="form-group">
                    <label for="valorImpresora">Valor imp. ($):</label>
                    <input type="number" id="valorImpresora" placeholder="1363990">
                </div>
                <div class="form-group">
                    <label for="margenError">% Error:</label>
                    <input type="number" id="margenError" value="30" placeholder="30">
                </div>
                <div class="form-group">
                    <label for="comisionML">Comisi√≥n ML (%):</label>
                    <input type="number" id="comisionML" value="30" step="1" placeholder="30">
                </div>
            </div>

            <h3>üîß Insumos</h3>
            <div class="calculator-grid">
                <div class="form-group">
                    <label for="insumos">Insumos ($):</label>
                    <input type="number" id="insumos" value="0" step="0.01" placeholder="0">
                </div>
            </div>

            <h3>üîó Extras Llaveros (opcional)</h3>
            <div class="calculator-grid">
                <div class="form-group">
                    <label for="precioCadena">Precio cadena ($/ud):</label>
                    <input type="number" id="precioCadena" value="0" step="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="cantidadCadenas">Cantidad cadenas:</label>
                    <input type="number" id="cantidadCadenas" value="0" min="0" placeholder="0">
                </div>
            </div>

            <h3>üí∏ Precios</h3>
            <div class="calculator-grid">
                <div class="form-group">
                    <label for="descuentoVentaPersona">Descuento Venta Persona (%):</label>
                    <input type="number" id="descuentoVentaPersona" step="1" value="5" min="0" max="100" placeholder="5">
                    <small>% menos que ML Competencia</small>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <label>
                    <input type="checkbox" id="debugMode" onchange="window.toggleDebugMode()">
                    üîß Modo Debug
                </label>
                <br><small>Mostrar herramientas de desarrollo y testing</small>
            </div>
        </section>

        <!-- Secci√≥n de Resultados -->
        <section id="resultados" class="hidden">
            <h2>üìä Resultados</h2>
            <div id="detalleResultados"></div>
        </section>
    </div>

    <script>
        // Declarar tipos para propiedades din√°micas en window
        declare global {
            interface Window {
                REF: { precioKg: number; precioKwh: number; consumoW: number; desgasteHoras: number; valorImpresora: number; margenError: number; comisionML: number };
                entradaActual: any;
                formatoArgentino: (numero: number) => string;
                formatoPrecioFinal: (numero: number) => string;
                generarAlertaGeneral: (precioVentaPersona: number, precioMLCompetencia: number, precioMLSinCompetencia: number) => string;
                cargarDatos: () => void;
                cargarHistorial: () => void;
                cargarDebugMode: () => void;
                toggleDebugMode: () => void;
                toggleHistorial: () => void;
                toggleCostosFijos: () => void;
                calcular: () => void;
                showTab: (tabId: string) => void;
                toggleCollapsible: (id: string, eventElement?: HTMLElement) => void;
                guardarDatos: () => void;
                cargarReferencias: () => void;
                resetear: () => void;
                exportarJSON: () => void;
                mostrarHistorial: () => void;
                limpiarHistorial: () => void;
                toggleTestInterno: () => void;
                nombrarEntrada: () => void;
                cargarDesdeHistorial: (id: string) => void;
                eliminarDelHistorial: (id: string) => void;
            }
        }
        
        // Valores de referencia para configuraci√≥n r√°pida
        window.REF = {
            precioKg: 20000,
            precioKwh: 234,
            consumoW: 120,
            desgasteHoras: 15000,
            valorImpresora: 1363990,
            margenError: 30,
            comisionML: 30
        };

        // Variable para entrada actual
        window.entradaActual = null;

        // Funci√≥n para formatear n√∫meros en estilo argentino
        window.formatoArgentino = function(numero: number) {
            return numero.toLocaleString('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        // Funci√≥n para redondear precios a centenas
        window.formatoPrecioFinal = function(numero: number) {
            const redondeado = Math.round(numero / 100) * 100;
            return redondeado.toLocaleString('es-AR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };

        // Funci√≥n para generar alertas generales
        window.generarAlertaGeneral = function(precioVentaPersona: number, precioMLCompetencia: number, precioMLSinCompetencia: number) {
            const precioMercadoLibre = parseFloat((document.getElementById('precioMercadoLibre') as HTMLInputElement)?.value || '0') || 0;
            
            if (precioMercadoLibre === 0) {
                return '';
            }
            
            if (precioMercadoLibre < precioMLCompetencia) {
                return `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ADVERTENCIA</strong><br>
                        El precio de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}) es menor que tu ML Competencia ($${window.formatoPrecioFinal(precioMLCompetencia)}). Quiz√°s no conviene ir por MercadoLibre.
                    </div>
                `;
            } else if (precioMercadoLibre >= precioMLCompetencia && precioMercadoLibre <= precioMLSinCompetencia) {
                const diferenciaPorcentaje = ((precioMercadoLibre - precioMLCompetencia) / precioMLCompetencia) * 100;
                return `
                    <div class="alert alert-info">
                        <strong>üí° RECOMENDACI√ìN</strong><br>
                        El precio de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}) es ${diferenciaPorcentaje.toFixed(1)}% mayor que tu ML Competencia. Debes ajustar el precio por encima del valor ML Competencia ($${window.formatoPrecioFinal(precioMLCompetencia)}) pero no exceder el valor de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}).
                    </div>
                `;
            } else {
                return `
                    <div class="alert alert-success">
                        <strong>üí° OPORTUNIDAD</strong><br>
                        El precio de MercadoLibre ($${window.formatoPrecioFinal(precioMercadoLibre)}) es mayor que tu ML Sin Competencia ($${window.formatoPrecioFinal(precioMLSinCompetencia)}). Debes ajustar el precio por encima del valor ML Sin Competencia ($${window.formatoPrecioFinal(precioMLSinCompetencia)}).
                    </div>
                `;
            }
        };

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            window.cargarDatos();
            window.cargarHistorial();
            window.cargarDebugMode();
        });

        // Gesti√≥n del modo debug
        window.cargarDebugMode = function() {
            const debugMode = sessionStorage.getItem('debugMode') === 'true';
            const debugCheckbox = document.getElementById('debugMode') as HTMLInputElement;
            if (debugCheckbox) {
                debugCheckbox.checked = debugMode;
                window.toggleDebugMode();
            } else {
                const testButton = document.getElementById('testButton');
                if (testButton) {
                    testButton.classList.add('hidden');
                }
            }
        };

        window.toggleDebugMode = function() {
            const debugCheckbox = document.getElementById('debugMode') as HTMLInputElement;
            const testButton = document.getElementById('testButton');
            
            if (debugCheckbox) {
                const isDebugMode = debugCheckbox.checked;
                sessionStorage.setItem('debugMode', String(isDebugMode));
                
                if (testButton) {
                    if (isDebugMode) {
                        testButton.classList.remove('hidden');
                    } else {
                        testButton.classList.add('hidden');
                    }
                }
            }
        };

        // Funciones de historial
        window.toggleHistorial = function() {
            const historial = document.getElementById('historial');
            if (!historial) return;
            if (historial.classList.contains('hidden')) {
                historial.classList.remove('hidden');
                window.mostrarHistorial();
            } else {
                historial.classList.add('hidden');
            }
        };

        window.toggleCostosFijos = function() {
            const costosFijos = document.getElementById('costosFijos');
            if (!costosFijos) return;
            if (costosFijos.classList.contains('hidden')) {
                costosFijos.classList.remove('hidden');
            } else {
                costosFijos.classList.add('hidden');
            }
        };

        // Funci√≥n principal de c√°lculo
        window.calcular = function() {
            // Obtener valores de entrada
            const precioKg = parseFloat((document.getElementById('costoFilamento') as HTMLInputElement)?.value || '0') || 0;
            const precioKwh = parseFloat((document.getElementById('precioKwh') as HTMLInputElement)?.value || '0') || 0;
            const consumoW = parseFloat((document.getElementById('consumoW') as HTMLInputElement)?.value || '0') || 0;
            const desgasteHoras = parseFloat((document.getElementById('desgasteHoras') as HTMLInputElement)?.value || '0') || 0;
            const valorImpresora = parseFloat((document.getElementById('valorImpresora') as HTMLInputElement)?.value || '0') || 0;
            const margenErrorPct = (parseFloat((document.getElementById('margenError') as HTMLInputElement)?.value || '0') || 0) / 100;
            const comisionMLPct = (parseFloat((document.getElementById('comisionML') as HTMLInputElement)?.value || '30') || 30) / 100;
            
            const horas = parseFloat((document.getElementById('horasImpresion') as HTMLInputElement)?.value || '0') || 0;
            const minutos = parseFloat((document.getElementById('minutosImpresion') as HTMLInputElement)?.value || '0') || 0;
            const tiempoTotalHoras = horas + (minutos / 60);
            
            const gramos = parseFloat((document.getElementById('gramosFilamento') as HTMLInputElement)?.value || '0') || 0;
            const insumos = parseFloat((document.getElementById('insumos') as HTMLInputElement)?.value || '0') || 0;
            let descuentoVentaPersona = parseFloat((document.getElementById('descuentoVentaPersona') as HTMLInputElement)?.value || '5') || 5;
            
            const cantidad = parseFloat((document.getElementById('cantidad') as HTMLInputElement)?.value || '1') || 1;
            const precioCadena = parseFloat((document.getElementById('precioCadena') as HTMLInputElement)?.value || '0') || 0;
            const cantidadCadenas = parseFloat((document.getElementById('cantidadCadenas') as HTMLInputElement)?.value || '0') || 0;

            // Validaci√≥n
            if (precioKg === 0 || gramos === 0) {
                alert('Ingresa precio filamento y gramos');
                return;
            }

            // C√°lculos
            const costoMaterial = (precioKg / 1000) * gramos;
            const costoElectricidad = ((consumoW / 1000) * precioKwh) * tiempoTotalHoras;
            const valorDepreciable = valorImpresora * 0.7;
            const costoDesgaste = desgasteHoras > 0 ? (valorDepreciable / desgasteHoras) * tiempoTotalHoras : 0;
            const costoBase = costoMaterial + costoElectricidad + costoDesgaste;
            const margenError = costoBase * margenErrorPct;
            const costoConMargen = costoBase + margenError;
            
            // Calcular precios ML
            const gananciaCompetencia = parseFloat(localStorage.getItem('gananciaCompetencia') || '175') || 175;
            const gananciaSinCompetencia = parseFloat(localStorage.getItem('gananciaSinCompetencia') || '700') || 700;
            
            const multiplicadorCompetencia = 1 + (gananciaCompetencia / 100);
            const costoConGananciaCompetencia = costoConMargen * multiplicadorCompetencia;
            const totalCobrarCompetencia = costoConGananciaCompetencia + insumos;
            const precioMLCompetencia = totalCobrarCompetencia / (1 - comisionMLPct);
            
            const multiplicadorSinCompetencia = 1 + (gananciaSinCompetencia / 100);
            const costoConGananciaSinCompetencia = costoConMargen * multiplicadorSinCompetencia;
            const totalCobrarSinCompetencia = costoConGananciaSinCompetencia + insumos;
            const precioMLSinCompetencia = totalCobrarSinCompetencia / (1 - comisionMLPct);
            
            // Calcular venta a persona
            const totalCobrar = precioMLCompetencia * (1 - descuentoVentaPersona / 100);
            
            // Redondear precios finales
            const totalCobrarRedondeado = Math.round(totalCobrar / 100) * 100;
            const precioMLCompetenciaRedondeado = Math.round(precioMLCompetencia / 100) * 100;
            const precioMLSinCompetenciaRedondeado = Math.round(precioMLSinCompetencia / 100) * 100;
            
            // Calcular ganancias reales
            const costoTotal = costoConMargen + insumos;
            const gananciaReal = totalCobrarRedondeado - costoTotal;
            const ingresoMLCompetencia = precioMLCompetenciaRedondeado * (1 - comisionMLPct);
            const ingresoMLSinCompetencia = precioMLSinCompetenciaRedondeado * (1 - comisionMLPct);
            const gananciaMLCompetencia = ingresoMLCompetencia - costoTotal;
            const gananciaMLSinCompetencia = ingresoMLSinCompetencia - costoTotal;
            
            // C√°lculos finales con cantidad y cadenas
            const costoCadenas = precioCadena * cantidadCadenas;
            const totalDirecto = (totalCobrarRedondeado * cantidad) + costoCadenas;
            const totalMLCompetenciaFinal = (precioMLCompetenciaRedondeado * cantidad) + costoCadenas;
            const totalMLSinCompetenciaFinal = (precioMLSinCompetenciaRedondeado * cantidad) + costoCadenas;

            // Generar HTML de resultados
            let html = `
                <!-- Pesta√±as de navegaci√≥n -->
                <div class="result-tabs">
                    <button class="tab-button active" onclick="window.showTab('venta-persona', this)">
                        üíµ Venta a Persona (-${descuentoVentaPersona}%)
                    </button>
                    <button class="tab-button" onclick="window.showTab('ml-competencia', this)">
                        üõí ML Competencia (${gananciaCompetencia}%)
                    </button>
                    <button class="tab-button" onclick="window.showTab('ml-sin-competencia', this)">
                        ‚≠ê ML Sin Competencia (${gananciaSinCompetencia}%)
                    </button>
                </div>
                
                <!-- Contenido de pesta√±as -->
                <div id="venta-persona" class="tab-content active">
                    <div class="price-final price-persona">
                        <h3>üíµ Venta a Persona (-${descuentoVentaPersona}% sobre ML Competencia)</h3>
                        <div>üìä Suma de Costos: $${Math.round(costoTotal).toLocaleString('es-AR')}</div>
                        <div>üí∞ Ganancia: $${Math.round(gananciaReal).toLocaleString('es-AR')}</div>
                        <div style="font-size: 1.5rem; margin-top: 15px;">
                            üíµ Precio Final: $${window.formatoPrecioFinal(totalCobrarRedondeado)}
                        </div>
                    </div>
                </div>
                
                <div id="ml-competencia" class="tab-content">
                    <div class="price-final price-competencia">
                        <h3>üõí ML Competencia (${gananciaCompetencia}%)</h3>
                        <div>üìä Suma de Costos: $${Math.round(costoTotal).toLocaleString('es-AR')}</div>
                        <div>üí∞ Ganancia: $${Math.round(gananciaMLCompetencia).toLocaleString('es-AR')}</div>
                        <div style="font-size: 1.5rem; margin-top: 15px;">
                            üíµ Precio Final: $${window.formatoPrecioFinal(precioMLCompetenciaRedondeado)}
                        </div>
                    </div>
                </div>
                
                <div id="ml-sin-competencia" class="tab-content">
                    <div class="price-final price-sin-competencia">
                        <h3>‚≠ê ML Sin Competencia (${gananciaSinCompetencia}%)</h3>
                        <div>üìä Suma de Costos: $${Math.round(costoTotal).toLocaleString('es-AR')}</div>
                        <div>üí∞ Ganancia: $${Math.round(gananciaMLSinCompetencia).toLocaleString('es-AR')}</div>
                        <div style="font-size: 1.5rem; margin-top: 15px;">
                            üíµ Precio Final: $${window.formatoPrecioFinal(precioMLSinCompetenciaRedondeado)}
                        </div>
                    </div>
                </div>
                
                ${window.generarAlertaGeneral(totalCobrarRedondeado, precioMLCompetenciaRedondeado, precioMLSinCompetenciaRedondeado)}
                
                <!-- Desglose de costos -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="window.toggleCollapsible('detalle-costos', this)">
                        <span>üìä Ver Desglose de Costos</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="detalle-costos">
                        <div>Material (${gramos}g): $${window.formatoArgentino(costoMaterial)}</div>
                        <div>Electricidad (${tiempoTotalHoras.toFixed(2)}h): $${window.formatoArgentino(costoElectricidad)}</div>
                        <div>Desgaste: $${window.formatoArgentino(costoDesgaste)}</div>
                        <div style="font-weight: bold; margin-top: 15px;">
                            üí∞ Costo Base: $${window.formatoArgentino(costoBase)}
                        </div>
                    </div>
                </div>
                
                <!-- Margen de error -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="window.toggleCollapsible('detalle-margen', this)">
                        <span>‚ö†Ô∏è Ver Margen de Error</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="detalle-margen">
                        <div>Margen de Error ${(margenErrorPct*100).toFixed(0)}%: $${window.formatoArgentino(margenError)}</div>
                        <div style="font-weight: bold; margin-top: 15px;">
                            Con Margen de Error: $${window.formatoArgentino(costoConMargen)}
                        </div>
                    </div>
                </div>
            `;

            // Agregar totales por cantidad si es necesario
            if (cantidad > 1 || costoCadenas > 0) {
                html += `
                <div style="margin-top: 30px;">
                    <h3>üì¶ Totales por Cantidad</h3>
                    <div class="test-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>üíµ Venta a Persona</th>
                                    <th>üõí ML Competencia</th>
                                    <th>‚≠ê ML Sin Competencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>üìä Cantidad</td>
                                    <td>${cantidad} unidades</td>
                                    <td>${cantidad} unidades</td>
                                    <td>${cantidad} unidades</td>
                                </tr>`;
                
                if (costoCadenas > 0) {
                    html += `
                                <tr>
                                    <td>üîó Cadenas</td>
                                    <td>$${Math.round(costoCadenas).toLocaleString('es-AR')}</td>
                                    <td>$${Math.round(costoCadenas).toLocaleString('es-AR')}</td>
                                    <td>$${Math.round(costoCadenas).toLocaleString('es-AR')}</td>
                                </tr>`;
                }
                
                html += `
                                <tr style="font-weight: bold;">
                                    <td>üíµ TOTAL FINAL</td>
                                    <td>$${window.formatoPrecioFinal(totalDirecto)}</td>
                                    <td>$${window.formatoPrecioFinal(totalMLCompetenciaFinal)}</td>
                                    <td>$${window.formatoPrecioFinal(totalMLSinCompetenciaFinal)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            // Mostrar resultados
            const detalleResultados = document.getElementById('detalleResultados');
            const resultados = document.getElementById('resultados');
            if (detalleResultados) detalleResultados.innerHTML = html;
            if (resultados) resultados.classList.remove('hidden');
            window.guardarDatos();
        };

        // Funci√≥n para mostrar pesta√±as
        window.showTab = function(tabId: string, buttonElement?: HTMLElement) {
            // Ocultar todas las pesta√±as
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            buttons.forEach(function(button) {
                button.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activar el bot√≥n correspondiente
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Buscar el bot√≥n por su onclick
                buttons.forEach(function(button) {
                    const onclick = button.getAttribute('onclick');
                    if (onclick && onclick.includes(tabId)) {
                        button.classList.add('active');
                    }
                });
            }
        };

        // Funci√≥n para toggle de collapsibles
        window.toggleCollapsible = function(id: string, eventElement?: HTMLElement) {
            const content = document.getElementById(id);
            if (!content) return;
            
            let header = null;
            if (eventElement) {
                header = eventElement.closest ? eventElement.closest('.collapsible-header') : eventElement.parentElement;
            } else {
                header = content.previousElementSibling;
            }
            
            if (!header) return;
            const icon = header.querySelector('span:last-child');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                if (icon) icon.textContent = '‚ñº';
            } else {
                content.classList.add('show');
                if (icon) icon.textContent = '‚ñ≤';
            }
        };

        // Funciones de persistencia de datos
        window.guardarDatos = function() {
            const getValue = (id: string) => (document.getElementById(id) as HTMLInputElement)?.value || '';
            const datos = {
                costoFilamento: getValue('costoFilamento'),
                precioKwh: getValue('precioKwh'),
                consumoW: getValue('consumoW'),
                desgasteHoras: getValue('desgasteHoras'),
                valorImpresora: getValue('valorImpresora'),
                margenError: getValue('margenError'),
                comisionML: getValue('comisionML'),
                horasImpresion: getValue('horasImpresion'),
                minutosImpresion: getValue('minutosImpresion'),
                gramosFilamento: getValue('gramosFilamento'),
                insumos: getValue('insumos'),
                descuentoVentaPersona: getValue('descuentoVentaPersona'),
                cantidad: getValue('cantidad'),
                precioMercadoLibre: getValue('precioMercadoLibre'),
                precioCadena: getValue('precioCadena'),
                cantidadCadenas: getValue('cantidadCadenas'),
            };
            sessionStorage.setItem('calc3D', JSON.stringify(datos));
        };

        window.cargarDatos = function() {
            const datos = sessionStorage.getItem('calc3D');
            if (datos) {
                const obj = JSON.parse(datos);
                Object.keys(obj).forEach(function(key) {
                    const elemento = document.getElementById(key) as HTMLInputElement;
                    if (elemento && obj[key]) {
                        if (key === 'descuentoVentaPersona') {
                            let valor = parseFloat(obj[key]);
                            if (isNaN(valor) || valor < 0) valor = 5;
                            if (valor > 50) valor = 50;
                            elemento.value = String(valor);
                        } else {
                            elemento.value = obj[key];
                        }
                    }
                });
            } else {
                window.cargarReferencias();
                const descInput = document.getElementById('descuentoVentaPersona') as HTMLInputElement;
                if (descInput) descInput.value = '5';
            }
        };

        window.cargarReferencias = function() {
            const setValue = (id: string, value: number) => {
                const el = document.getElementById(id) as HTMLInputElement;
                if (el) el.value = String(value);
            };
            setValue('costoFilamento', window.REF.precioKg);
            setValue('precioKwh', window.REF.precioKwh);
            setValue('consumoW', window.REF.consumoW);
            setValue('desgasteHoras', window.REF.desgasteHoras);
            setValue('valorImpresora', window.REF.valorImpresora);
            setValue('margenError', window.REF.margenError);
            setValue('comisionML', window.REF.comisionML);
            window.guardarDatos();
            alert('Referencias cargadas\nPLA: $20k/kg | kWh: $234\nConsumo: 120W | Vida √∫til: 15.000h\nImpresora: $1.363.990 | Comisi√≥n ML: 30%');
        };

        window.resetear = function() {
            if (confirm('¬øBorrar todos los datos?')) {
                sessionStorage.removeItem('calc3D');
                localStorage.removeItem('historial3D');
                location.reload();
            }
        };

        window.exportarJSON = function() {
            const datos = sessionStorage.getItem('calc3D');
            const historial = localStorage.getItem('historial3D');
            const exportData = {
                configuracion: datos ? JSON.parse(datos) : {},
                historial: historial ? JSON.parse(historial) : [],
                fecha: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'creatopia-calc-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Funciones de historial (simplificadas)
        window.cargarHistorial = function() {
            if (!localStorage.getItem('historial3D')) {
                localStorage.setItem('historial3D', '[]');
            }
        };

        window.mostrarHistorial = function() {
            const historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
            const lista = document.getElementById('historialLista');
            if (!lista) return;
            
            if (historial.length === 0) {
                lista.innerHTML = '<p>No hay c√°lculos guardados</p>';
                return;
            }
            
            lista.innerHTML = historial.map(function(item: any) {
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 15px; margin: 10px 0;">
                        <strong>${item.nombre || 'C√°lculo sin nombre'}</strong><br>
                        <small>${new Date(item.fecha).toLocaleString('es-AR')}</small><br>
                        <small>${item.datos?.entrada?.pieza?.gramosFilamento || 0}g - ${item.datos?.entrada?.pieza?.horasImpresion || 0}:${(item.datos?.entrada?.pieza?.minutosImpresion || 0).toString().padStart(2,'0')}</small>
                        <div style="margin-top: 10px;">
                            <button onclick="window.cargarDesdeHistorial('${item.id}')" class="btn-secondary" style="margin-right: 10px;">Cargar</button>
                            <button onclick="window.eliminarDelHistorial('${item.id}')" class="btn-outline">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.limpiarHistorial = function() {
            if (confirm('¬øEliminar TODO el historial?')) {
                localStorage.setItem('historial3D', '[]');
                window.mostrarHistorial();
            }
        };

        // Funciones de test (simplificadas)
        window.toggleTestInterno = function() {
            alert('Funci√≥n de tests en desarrollo para la versi√≥n Astro');
        };

        window.nombrarEntrada = function() {
            const nombre = prompt('Nombre para este c√°lculo:');
            if (nombre) {
                // Guardar en historial con nombre
                alert('C√°lculo guardado como: ' + nombre);
            }
        };

        // Funciones de historial completas
        window.cargarDesdeHistorial = function(id: string) {
            const historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
            const item = historial.find((h: any) => h.id === id);
            
            if (!item) {
                alert('No se encontr√≥ el c√°lculo en el historial');
                return;
            }
            
            const entrada = item.datos.entrada;
            const setValue = (id: string, value: any) => {
                const el = document.getElementById(id) as HTMLInputElement;
                if (el) el.value = String(value || '');
            };
            
            // Cargar costos fijos
            if (entrada.costosFijos) {
                setValue('costoFilamento', entrada.costosFijos.precioKg);
                setValue('precioKwh', entrada.costosFijos.precioKwh);
                setValue('consumoW', entrada.costosFijos.consumoW);
                setValue('desgasteHoras', entrada.costosFijos.desgasteHoras);
                setValue('valorImpresora', entrada.costosFijos.valorImpresora);
                setValue('margenError', entrada.costosFijos.margenError);
                setValue('comisionML', entrada.costosFijos.comisionML);
            }
            
            // Cargar datos de pieza
            if (entrada.pieza) {
                setValue('horasImpresion', entrada.pieza.horasImpresion);
                setValue('minutosImpresion', entrada.pieza.minutosImpresion);
                setValue('gramosFilamento', entrada.pieza.gramosFilamento);
            }
            
            // Cargar datos de producci√≥n
            if (entrada.produccion) {
                setValue('cantidad', entrada.produccion.cantidad || 1);
            }
            
            // Cargar extras
            if (entrada.extras) {
                setValue('insumos', entrada.extras.insumos || 0);
                setValue('precioCadena', entrada.extras.precioCadena || 0);
                setValue('cantidadCadenas', entrada.extras.cantidadCadenas || 0);
            }
            
            // Cargar descuento si existe
            if (entrada.descuentoVentaPersona !== undefined) {
                setValue('descuentoVentaPersona', entrada.descuentoVentaPersona || 5);
            }
            
            window.guardarDatos();
            alert('Datos cargados del historial');
            const historialEl = document.getElementById('historial');
            if (historialEl && !historialEl.classList.contains('hidden')) {
                window.toggleHistorial();
            }
            window.calcular();
        };

        window.eliminarDelHistorial = function(id: string) {
            if (!confirm('¬øEliminar este c√°lculo del historial?')) return;
            
            let historial = JSON.parse(localStorage.getItem('historial3D') || '[]');
            historial = historial.filter((h: any) => h.id !== id);
            localStorage.setItem('historial3D', JSON.stringify(historial));
            window.mostrarHistorial();
        };
    </script>
    </div>
</BaseTailwind>