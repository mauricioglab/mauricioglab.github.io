---
import BlogLayout from '@layouts/BlogLayout.astro';
import { getBlogPosts, normalizeBaseUrl } from '@utils/blog';
import PostCard from '@components/blog/PostCard.astro';

export const prerender = true;

const posts = await getBlogPosts();
const normalizedBase = normalizeBaseUrl(import.meta.env.BASE_URL);
const currentUrl = `${Astro.site}${normalizedBase}blog/search/`;
---

<BlogLayout 
  title="Buscar | Blog"
  description="Buscar artículos del blog"
  blogTitle="Blog"
  blogSubtitle="Artículos y pensamientos"
>
  <slot name="head">
    <link rel="canonical" href={currentUrl} />
  </slot>

  <div>
    <header class="mb-12 text-center">
      <h1 class="entry-title text-4xl font-normal text-[#594a42] mb-4">Buscar</h1>
      <p class="text-lg text-[#594a42]">Busca artículos por título, contenido o categoría</p>
    </header>

    <div class="mb-12">
      <label for="search-input" class="sr-only">Buscar artículos</label>
      <input
        type="text"
        id="search-input"
        placeholder="Escribe para buscar..."
        class="w-full px-4 py-3 text-lg border border-[#e5e5e5] rounded focus:outline-none focus:border-[#594a42] text-[#594a42] font-[inherit]"
        aria-label="Buscar artículos"
      />
    </div>

    <div id="search-results">
      <div class="posts-list" role="list">
        {posts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
      <div id="no-results" class="hidden text-center text-[#594a42] text-lg" role="status" aria-live="polite">
        <p>No se encontraron resultados para tu búsqueda.</p>
      </div>
    </div>
  </div>
</BlogLayout>

<script>
  (function() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const postCards = document.querySelectorAll('.posts-list article');
    const noResults = document.getElementById('no-results');
    const postsList = document.querySelector('.posts-list') as HTMLElement;
    
    if (!searchInput || postCards.length === 0) return;
    
    let debounceTimer: ReturnType<typeof setTimeout> | null = null;
    
    function performSearch(query: string) {
      let visibleCount = 0;
      
      postCards.forEach((card) => {
        const title = card.getAttribute('data-title')?.toLowerCase() || '';
        const description = card.getAttribute('data-description')?.toLowerCase() || '';
        const categories = card.getAttribute('data-categories')?.toLowerCase() || '';
        
        const matches = 
          title.includes(query) || 
          description.includes(query) || 
          categories.includes(query);
        
        (card as HTMLElement).style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });
      
      if (query && visibleCount === 0) {
        if (postsList) postsList.style.display = 'none';
        if (noResults) noResults.classList.remove('hidden');
      } else {
        if (postsList) postsList.style.display = 'block';
        if (noResults) noResults?.classList.add('hidden');
      }
    }
    
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
      
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }
      
      debounceTimer = setTimeout(() => {
        performSearch(query);
      }, 150);
    });
  })();
</script>
