---
import BlogLayout from '../../../layouts/BlogLayout.astro';
import { getBlogPosts, normalizeBaseUrl } from '../../../utils/blog';
import PostCard from '../../../components/blog/PostCard.astro';

export const prerender = true;

const posts = await getBlogPosts();
const normalizedBase = normalizeBaseUrl(import.meta.env.BASE_URL);
const currentUrl = `${Astro.site}${normalizedBase}blog/archives/`;

// Group posts by year and month
interface PostsByMonth {
  [monthIndex: number]: typeof posts;
}

interface PostsByYear {
  [year: number]: PostsByMonth;
}

const postsByYearMonth: PostsByYear = {};

posts.forEach((post) => {
  const year = post.data.pubDate.getFullYear();
  const monthIndex = post.data.pubDate.getMonth();
  
  if (!postsByYearMonth[year]) {
    postsByYearMonth[year] = {};
  }
  if (!postsByYearMonth[year][monthIndex]) {
    postsByYearMonth[year][monthIndex] = [];
  }
  postsByYearMonth[year][monthIndex].push(post);
});

// Sort years descending and months within each year
const sortedYears = Object.keys(postsByYearMonth)
  .map(Number)
  .sort((a, b) => b - a);

const monthNames = [
  'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
  'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
];
---

<BlogLayout 
  title="Archivo | Blog"
  description="Archivo de artículos del blog"
  blogTitle="Blog"
  blogSubtitle="Artículos y pensamientos"
>
  <slot name="head">
    <link rel="canonical" href={currentUrl} />
  </slot>

  <div>
    <header class="mb-12 text-center">
      <h1 class="entry-title text-4xl font-normal text-[#594a42] mb-4">Archivo</h1>
      <p class="text-lg text-[#594a42]">Todos los artículos organizados por fecha</p>
    </header>

    {sortedYears.length === 0 ? (
      <p class="text-center text-[#594a42]">No hay artículos archivados.</p>
    ) : (
      <div class="archives-content">
        {sortedYears.map((year) => {
          const months = Object.keys(postsByYearMonth[year])
            .map(Number)
            .sort((a, b) => b - a);
          
          return (
            <section class="year-section mb-12" aria-labelledby={`year-${year}`}>
              <h2 id={`year-${year}`} class="text-3xl font-normal text-[#594a42] mb-6 pb-3 border-b border-[#e5e5e5]">{year}</h2>
              
              {months.map((monthIndex) => {
                const monthPosts = postsByYearMonth[year][monthIndex];
                const monthName = monthNames[monthIndex];
                
                return (
                  <div class="month-section mb-8">
                    <h3 class="text-xl font-normal text-[#594a42] mb-4 capitalize">{monthName} {year}</h3>
                    <div class="posts-list" role="list">
                      {monthPosts.map((post) => (
                        <PostCard post={post} />
                      ))}
                    </div>
                  </div>
                );
              })}
            </section>
          );
        })}
      </div>
    )}
  </div>
</BlogLayout>
