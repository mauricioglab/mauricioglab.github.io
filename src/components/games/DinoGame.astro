---
// DinoGame.astro - Mini juego Dino Runner estilo Chrome
---

<div id="dinoGameModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center backdrop-blur-sm">
  <div class="bg-gray-900 rounded-2xl p-4 max-w-md w-full mx-4 shadow-2xl border-2 border-orange-500 text-center">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-bold text-orange-400">ü¶ñ Dino Run</h2>
      <button id="closeDinoGame" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
    </div>
    
    <div class="flex justify-between text-sm mb-2">
      <span class="text-orange-400">Puntos: <span id="dinoScore">0</span></span>
      <span class="text-gray-400">R√©cord: <span id="dinoHighScore">0</span></span>
    </div>
    
    <canvas id="dinoCanvas" class="bg-gray-800 rounded border border-gray-700 mx-auto block"></canvas>
    
    <p id="dinoStatus" class="text-gray-400 text-xs mt-2">Espacio o Click para saltar</p>
    
    <button id="startDinoGame" class="mt-3 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-full transition-colors text-sm">
      Jugar
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('dinoGameModal');
    const closeBtn = document.getElementById('closeDinoGame');
    const startBtn = document.getElementById('startDinoGame') as HTMLButtonElement;
    const canvas = document.getElementById('dinoCanvas') as HTMLCanvasElement;
    const scoreEl = document.getElementById('dinoScore');
    const highScoreEl = document.getElementById('dinoHighScore');
    const statusEl = document.getElementById('dinoStatus');
    const gameTabBtn = document.getElementById('gameTabBtn');
    
    const ctx = canvas?.getContext('2d');
    canvas.width = 360;
    canvas.height = 180;
    
    // F√≠sica ajustada para fluidez (60fps target)
    const GRAVITY = 0.45, JUMP = -9.5, GROUND = 140, DINO_X = 40;
    const TARGET_FPS = 60, FRAME_TIME = 1000 / TARGET_FPS;
    
    let dino = { y: GROUND, vy: 0 };
    let obstacles: {x: number}[] = [];
    let score = 0, speed = 3.5, gameLoop: number | null = null, gameRunning = false;
    let lastTime = 0;
    let highScore = parseInt(localStorage.getItem('dinoHighScore') || '0');
    
    if (highScoreEl) highScoreEl.textContent = String(highScore);
    
    gameTabBtn?.addEventListener('click', () => {
      modal?.classList.remove('hidden');
      modal?.classList.add('flex');
      resetGame();
    });
    
    function closeModal() {
      modal?.classList.add('hidden');
      modal?.classList.remove('flex');
      stopGame();
    }
    
    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    
    function resetGame() {
      stopGame();
      dino = { y: GROUND, vy: 0 };
      obstacles = [];
      score = 0;
      speed = 3.5;
      lastTime = 0;
      gameRunning = false;
      if (scoreEl) scoreEl.textContent = '0';
      if (statusEl) statusEl.textContent = 'Espacio o Click para saltar';
      if (startBtn) { startBtn.disabled = false; startBtn.textContent = 'Jugar'; }
      draw();
    }
    
    function stopGame() {
      if (gameLoop) { cancelAnimationFrame(gameLoop); gameLoop = null; }
      gameRunning = false;
    }
    
    function jump() {
      if (dino.y >= GROUND - 1) dino.vy = JUMP;
    }
    
    function draw() {
      if (!ctx) return;
      ctx.fillStyle = '#1f2937';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Suelo
      ctx.strokeStyle = '#6b7280';
      ctx.beginPath();
      ctx.moveTo(0, GROUND + 28);
      ctx.lineTo(canvas.width, GROUND + 28);
      ctx.stroke();
      
      // Dino y obst√°culos con emojis
      ctx.font = '28px serif';
      // Voltear dino horizontalmente
      ctx.save();
      ctx.scale(-1, 1);
      ctx.fillText('ü¶ñ', -DINO_X - 28, dino.y + 24);
      ctx.restore();
      obstacles.forEach(o => ctx.fillText('üåµ', o.x, GROUND + 24));
    }
    
    function update(timestamp: number) {
      if (!gameRunning) return;
      
      // Delta time para fluidez consistente
      if (!lastTime) lastTime = timestamp;
      const delta = Math.min((timestamp - lastTime) / FRAME_TIME, 2);
      lastTime = timestamp;
      
      // F√≠sica con delta time
      dino.vy += GRAVITY * delta;
      dino.y += dino.vy * delta;
      if (dino.y >= GROUND) { dino.y = GROUND; dino.vy = 0; }
      
      // Mover obst√°culos
      obstacles.forEach(o => o.x -= speed * delta);
      obstacles = obstacles.filter(o => o.x > -30);
      
      // Spawn con distancia m√≠nima (m√°s espaciados)
      const lastObs = obstacles[obstacles.length - 1];
      if (!lastObs || lastObs.x < canvas.width - 200 - Math.random() * 120) {
        obstacles.push({ x: canvas.width });
      }
      
      // Colisi√≥n (hitbox ajustada)
      for (const o of obstacles) {
        if (o.x < DINO_X + 20 && o.x + 18 > DINO_X + 4 && dino.y > GROUND - 22) {
          gameOver();
          return;
        }
      }
      
      // Score y velocidad gradual
      score++;
      if (scoreEl) scoreEl.textContent = String(Math.floor(score / 10));
      if (score % 600 === 0 && speed < 8) speed += 0.3;
      
      draw();
      gameLoop = requestAnimationFrame(update);
    }
    
    function gameOver() {
      stopGame();
      const finalScore = Math.floor(score / 10);
      if (finalScore > highScore) {
        highScore = finalScore;
        localStorage.setItem('dinoHighScore', String(highScore));
        if (highScoreEl) highScoreEl.textContent = String(highScore);
        if (statusEl) statusEl.textContent = 'üèÜ ¬°Nuevo r√©cord!';
      } else {
        if (statusEl) statusEl.textContent = 'üíÄ Game Over';
      }
      if (startBtn) { startBtn.disabled = false; startBtn.textContent = 'Reintentar'; }
    }
    
    function startGame() {
      resetGame();
      gameRunning = true;
      lastTime = 0;
      if (startBtn) startBtn.disabled = true;
      if (statusEl) statusEl.textContent = 'üéÆ ¬°Salta!';
      gameLoop = requestAnimationFrame(update);
    }
    
    startBtn?.addEventListener('click', startGame);
    canvas?.addEventListener('click', () => { if (gameRunning) jump(); });
    
    document.addEventListener('keydown', (e) => {
      if (!modal || modal.classList.contains('hidden')) return;
      if (e.key === 'Escape') { closeModal(); return; }
      if (e.key === ' ') {
        e.preventDefault();
        if (gameRunning) {
          jump();
        } else {
          startGame();
        }
      }
    });
  });
</script>
