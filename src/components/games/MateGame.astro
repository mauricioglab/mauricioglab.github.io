---
// MateGame.astro - Mini juego del Mate que esquiva el hielo
---

<div id="mateGameModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center backdrop-blur-sm">
  <div class="bg-gray-900 rounded-2xl p-4 max-w-md w-full mx-4 shadow-2xl border-2 border-green-600 text-center">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-bold text-green-400">üßâ Mate Run</h2>
      <button id="closeMateGame" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
    </div>
    
    <div class="flex justify-between text-sm mb-2">
      <span class="text-green-400">Puntos: <span id="mateScore">0</span></span>
      <span class="text-gray-400">R√©cord: <span id="mateHighScore">0</span></span>
    </div>
    
    <canvas id="mateCanvas" class="bg-gray-800 rounded border border-gray-700 mx-auto block"></canvas>
    
    <p id="mateStatus" class="text-gray-400 text-xs mt-2">Espacio o Click para saltar</p>
    
    <button id="startMateGame" class="mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full transition-colors text-sm">
      Cebar
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('mateGameModal');
    const closeBtn = document.getElementById('closeMateGame');
    const startBtn = document.getElementById('startMateGame') as HTMLButtonElement;
    const canvas = document.getElementById('mateCanvas') as HTMLCanvasElement;
    const scoreEl = document.getElementById('mateScore');
    const highScoreEl = document.getElementById('mateHighScore');
    const statusEl = document.getElementById('mateStatus');
    const gameTabBtn = document.getElementById('gameTabBtn');
    
    const ctx = canvas?.getContext('2d');
    canvas.width = 360;
    canvas.height = 180;
    
    // F√≠sica ajustada para fluidez (60fps target)
    const GRAVITY = 0.45, JUMP = -9.5, GROUND = 140, MATE_X = 40;
    const TARGET_FPS = 60, FRAME_TIME = 1000 / TARGET_FPS;
    
    let mate = { y: GROUND, vy: 0 };
    let obstacles: {x: number}[] = [];
    let score = 0, speed = 3.5, gameLoop: number | null = null, gameRunning = false;
    let lastTime = 0;
    let highScore = parseInt(localStorage.getItem('mateHighScore') || '0');
    
    if (highScoreEl) highScoreEl.textContent = String(highScore);
    
    gameTabBtn?.addEventListener('click', () => {
      modal?.classList.remove('hidden');
      modal?.classList.add('flex');
      resetGame();
    });
    
    function closeModal() {
      modal?.classList.add('hidden');
      modal?.classList.remove('flex');
      stopGame();
    }
    
    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    
    function resetGame() {
      stopGame();
      mate = { y: GROUND, vy: 0 };
      obstacles = [];
      score = 0;
      speed = 3.5;
      lastTime = 0;
      gameRunning = false;
      if (scoreEl) scoreEl.textContent = '0';
      if (statusEl) statusEl.textContent = 'Espacio o Click para saltar';
      if (startBtn) { startBtn.disabled = false; startBtn.textContent = 'Cebar'; }
      draw();
    }
    
    function stopGame() {
      if (gameLoop) { cancelAnimationFrame(gameLoop); gameLoop = null; }
      gameRunning = false;
    }
    
    function jump() {
      if (mate.y >= GROUND - 1) mate.vy = JUMP;
    }
    
    function draw() {
      if (!ctx) return;
      ctx.fillStyle = '#1f2937';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Suelo
      ctx.strokeStyle = '#6b7280';
      ctx.beginPath();
      ctx.moveTo(0, GROUND + 28);
      ctx.lineTo(canvas.width, GROUND + 28);
      ctx.stroke();
      
      // Mate y hielos con emojis
      ctx.font = '28px serif';
      // Mate (sin voltear, se ve bien as√≠)
      ctx.fillText('üßâ', MATE_X, mate.y + 24);
      // Hielos como obst√°culos
      obstacles.forEach(o => ctx.fillText('üßä', o.x, GROUND + 24));
    }
    
    function update(timestamp: number) {
      if (!gameRunning) return;
      
      // Delta time para fluidez consistente
      if (!lastTime) lastTime = timestamp;
      const delta = Math.min((timestamp - lastTime) / FRAME_TIME, 2);
      lastTime = timestamp;
      
      // F√≠sica con delta time
      mate.vy += GRAVITY * delta;
      mate.y += mate.vy * delta;
      if (mate.y >= GROUND) { mate.y = GROUND; mate.vy = 0; }
      
      // Mover obst√°culos
      obstacles.forEach(o => o.x -= speed * delta);
      obstacles = obstacles.filter(o => o.x > -30);
      
      // Spawn con distancia m√≠nima (m√°s espaciados)
      const lastObs = obstacles[obstacles.length - 1];
      if (!lastObs || lastObs.x < canvas.width - 200 - Math.random() * 120) {
        obstacles.push({ x: canvas.width });
      }
      
      // Colisi√≥n (hitbox ajustada)
      for (const o of obstacles) {
        if (o.x < MATE_X + 20 && o.x + 18 > MATE_X + 4 && mate.y > GROUND - 22) {
          gameOver();
          return;
        }
      }
      
      // Score y velocidad gradual
      score++;
      if (scoreEl) scoreEl.textContent = String(Math.floor(score / 10));
      if (score % 600 === 0 && speed < 8) speed += 0.3;
      
      draw();
      gameLoop = requestAnimationFrame(update);
    }
    
    function gameOver() {
      stopGame();
      const finalScore = Math.floor(score / 10);
      if (finalScore > highScore) {
        highScore = finalScore;
        localStorage.setItem('mateHighScore', String(highScore));
        if (highScoreEl) highScoreEl.textContent = String(highScore);
        if (statusEl) statusEl.textContent = 'üèÜ ¬°Nuevo r√©cord!';
      } else {
        if (statusEl) statusEl.textContent = 'ü•∂ ¬°Se enfri√≥ el mate!';
      }
      if (startBtn) { startBtn.disabled = false; startBtn.textContent = 'Recebar'; }
    }
    
    function startGame() {
      resetGame();
      gameRunning = true;
      lastTime = 0;
      if (startBtn) startBtn.disabled = true;
      if (statusEl) statusEl.textContent = 'üßâ ¬°Esquiv√° el hielo!';
      gameLoop = requestAnimationFrame(update);
    }
    
    startBtn?.addEventListener('click', startGame);
    canvas?.addEventListener('click', () => { if (gameRunning) jump(); });
    
    document.addEventListener('keydown', (e) => {
      if (!modal || modal.classList.contains('hidden')) return;
      if (e.key === 'Escape') { closeModal(); return; }
      if (e.key === ' ') {
        e.preventDefault();
        if (gameRunning) {
          jump();
        } else {
          startGame();
        }
      }
    });
  });
</script>
